<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eryn Basic Tutorial &mdash; Eryn 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="More Advanced Eryn Examples" href="more_tutorials.html" />
    <link rel="prev" title="Utilities" href="../user/utils.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: coral" >

          
          
          <a href="../index.html" class="icon icon-home">
            Eryn
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/ensemble.html">Ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/state.html">State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/backend.html">Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/moves.html">Moves</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/prior.html">Priors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/temper.html">Parallel Tempering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/utils.html">Utilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Eryn Basic Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#MCMC-Basics">MCMC Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#The-Tree-Metaphor">The Tree Metaphor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Getting-Started-with-the-Ensemble-Sampler">Getting Started with the Ensemble Sampler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Backend-Objects">Backend Objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#5-dimensional-Arrays">5-dimensional Arrays</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#State-Objects">State Objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Branches">Branches</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Parallel-Tempering">Parallel Tempering</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Add-Reversible-Jump-MCMC-(model-count-uncertainty)">Add Reversible Jump MCMC (model count uncertainty)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Add-multiple-branches">Add multiple branches</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Moves">Moves</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Example-diagonal-covariance-move">Example diagonal covariance move</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Gibbs-Sampling">Gibbs Sampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Example:-GroupStretchMove">Example: <code class="docutils literal notranslate"><span class="pre">GroupStretchMove</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Utilities">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Branch-Supplimental">Branch Supplimental</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Transform-Container">Transform Container</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Multivariate-Prior-Distributions">Multivariate Prior Distributions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Periodic-Container">Periodic Container</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Stopping-&amp;-Update-Functions">Stopping &amp; Update Functions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="more_tutorials.html">More Advanced Eryn Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">General Information:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../general/todos.html">Code Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/todos.html#code-todos">Code TODOs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: coral" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Eryn</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Eryn Basic Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorial/Eryn_tutorial.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="../user/utils.html" class="btn btn-neutral float-left" title="Utilities" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="more_tutorials.html" class="btn btn-neutral float-right" title="More Advanced Eryn Examples" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">eryn.ensemble</span> <span class="kn">import</span> <span class="n">EnsembleSampler</span>
<span class="kn">from</span> <span class="nn">eryn.state</span> <span class="kn">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">eryn.prior</span> <span class="kn">import</span> <span class="n">ProbDistContainer</span><span class="p">,</span> <span class="n">uniform_dist</span>
<span class="kn">from</span> <span class="nn">eryn.utils</span> <span class="kn">import</span> <span class="n">TransformContainer</span>
<span class="kn">from</span> <span class="nn">eryn.moves</span> <span class="kn">import</span> <span class="n">GaussianMove</span><span class="p">,</span> <span class="n">StretchMove</span><span class="p">,</span> <span class="n">CombineMove</span>
<span class="kn">from</span> <span class="nn">eryn.utils.utility</span> <span class="kn">import</span> <span class="n">groups_from_inds</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># set random seed</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">corner</span>
<br/></pre></div>
</div>
</div>
<section id="Eryn-Basic-Tutorial">
<h1>Eryn Basic Tutorial<a class="headerlink" href="#Eryn-Basic-Tutorial" title="Link to this heading"></a></h1>
<p>Eryn is an advanced MCMC sampler. It has the capability to run with parallel tempering, multiple model types, and unknown counts within each model type using Reversible-Jump MCMC techniques. Eryn is heavily based on <a class="reference external" href="https://emcee.readthedocs.io/en/stable/">emcee</a>. The <code class="docutils literal notranslate"><span class="pre">emcee</span></code> base structure with the Ensemble Sampler, State objects, proposal setup, and storage backends is carried over into Eryn with small changes to account for the increased complexity. In a simple sense, Eryn is an
advanced (and slightly more complicated) version of <code class="docutils literal notranslate"><span class="pre">emcee</span></code>.</p>
<p>In this tutorial, we will go through much of what is available in Eryn. We will start with a basic sampling operation to illustrate how to build and navigate common objects in Eryn. We will then scale up the complexity to understand how to use Eryn in different circumstances.</p>
<p>If you use Eryn in your publication, please cite the paper <a class="reference external" href="https://arxiv.org/abs/2303.02164">arXiv:2303.02164</a>, its <a class="reference external" href="https://zenodo.org/record/7705496#.ZAhzukJKjlw">zenodo</a>, and <a class="reference external" href="https://emcee.readthedocs.io/en/stable/">emcee</a>. The documentation for Eryn can be found here: <a class="reference external" href="https://mikekatz04.github.io/Eryn">mikekatz04.github.io/Eryn</a>. You will find the code on Github: <a class="reference external" href="https://github.com/mikekatz04/Eryn">github.com/mikekatz04/Eryn</a>.</p>
<section id="MCMC-Basics">
<h2>MCMC Basics<a class="headerlink" href="#MCMC-Basics" title="Link to this heading"></a></h2>
<p>Here we will go through the basics of MCMC. For a better overall understanding of MCMC, see the Eryn paper: <a class="reference external" href="https://arxiv.org/abs/2303.02164">arXiv:2303.02164</a>.</p>
<p>The goal of MCMC is to assess the posterior probablity on parameters <span class="math notranslate nohighlight">\((\vec{\theta})\)</span> from a model (<span class="math notranslate nohighlight">\(\mathcal{M}\)</span>), given some data <span class="math notranslate nohighlight">\(y\)</span>: <span class="math notranslate nohighlight">\(p(\vec{\theta}, \mathcal{M}|y)\)</span>. We can rewrite this probability using Bayes’ rule:</p>
<div class="math notranslate nohighlight">
\[p(\vec{\theta}|y)=\frac{p(y|\vec{\theta}, \mathcal{M})p(\vec{\theta}, \mathcal{M})}{p(y|\mathcal{M})}\]</div>
<p>.</p>
<p>Here are the main pieces of the righthand side: * Posterior - <span class="math notranslate nohighlight">\(p(\vec{\theta}|y)\)</span>: The probability distribution on the parameters, the main goal of MCMC. We will refer to this from now on as <span class="math notranslate nohighlight">\(\pi(\vec{\theta})\)</span>. * Likelihood - <span class="math notranslate nohighlight">\(p(y|\vec{\theta}, \mathcal{M})\)</span>: This is the surface that MCMC will sample (weighted by the prior). We will refer to the Likelihood. We will write this from now on as <span class="math notranslate nohighlight">\(\mathcal{L}(\vec{\theta}, \mathcal{M})\)</span>. * Prior -
<span class="math notranslate nohighlight">\(p(\vec{\theta}, \mathcal{M})\)</span>: Prior probability on the parameters and the model chosen. * Evidence - <span class="math notranslate nohighlight">\(p(y|\mathcal{M})\)</span>: The evidence is the integral of the numerator in the equation above integrated over all of the parameter space: <span class="math notranslate nohighlight">\(\int_{\vec{\theta}_\mathcal{M}}\mathcal{L}(\vec{\theta}, \mathcal{M})d\vec{\theta}\)</span>. This will be referred to below as <span class="math notranslate nohighlight">\(Z(\mathcal{M})\)</span> (the evidence of model <span class="math notranslate nohighlight">\(\mathcal{M}\)</span>).</p>
<p>MCMC numerically draws samples from the posterior density by exploring the Likelihood surface weighted by the prior. In most MCMC applications, the evidence will be intractable and ignored as it is just a constant factor over all samples. There are methods to estimate the evidence that we will discuss below.</p>
<p>MCMC is special because of <strong>how it explores</strong>. Using a concept called “Detailed Balance,” walkers exploring the Likelihood surface preferentially move upwards, but probabilistically can move downwards. This allows for a full exploration of the peak of the Likelihood surface rather than just moving directly towards the highest point.</p>
<p>There are requirements to make this work properly that we will discuss below when we discsuss MCMC “moves” or “proposals.” At a basic level, also know as the Metropolis-Hastings algorithm, MCMC works like this: 1. It starts with a current point in parameter space, <span class="math notranslate nohighlight">\(\vec{\theta}_t\)</span>. 2. The sampler proposes a new position for this walker: <span class="math notranslate nohighlight">\(\vec{\theta}_{t+1}\)</span>. 3. It then accepts this new position with probabilty, <span class="math notranslate nohighlight">\(\alpha\)</span>:</p>
<div class="math notranslate nohighlight">
\[\min\left(1, \frac{\pi(\vec{\theta}_{t+1})q(\vec{\theta}_{t}|\vec{\theta}_{t+1})}{\pi(\vec{\theta}_{t})q(\vec{\theta}_{t+1}|\vec{\theta}_{t})}\right)\]</div>
<p>. 4. Repeat many times.</p>
<p><span class="math notranslate nohighlight">\(q\)</span> is the proposal distribution to move from <span class="math notranslate nohighlight">\(\vec{\theta}_{t}\)</span> to <span class="math notranslate nohighlight">\(\vec{\theta}_{t+1}\)</span> or vice versa. If the proposal distribution is symmetric, the <span class="math notranslate nohighlight">\(q\)</span> distributions drop out and we are left with the fraction of posterior probabilities. We can see, in this case, if the new posterior probability is larger than the previous probability, the move will ALWAYS be accepted. If the new posterior probability is worse than the old probability, the move will be accepted with a
probability equal to this fraction. Therefore, as the new value becomes worse and worse compared to the old value, the probability of acceptance decreases.</p>
</section>
<section id="The-Tree-Metaphor">
<h2>The Tree Metaphor<a class="headerlink" href="#The-Tree-Metaphor" title="Link to this heading"></a></h2>
<p>Before we get into using the sampler, we will discuss the “infamous” tree metaphor. It helped in thinking about the early creation of Eryn and has carried through to the end. <code class="docutils literal notranslate"><span class="pre">Eryn</span></code> is the Sindarin word for “forest” or “woods.” The purpose of this metaphor is to simplify the complex dimensionality associated with changing models and model counts in MCMC. We choose not to use “model” and “model counts” everywhere because those descriptions can quickly become confusing.</p>
<p>We start with a forest with a bunch of trees. These trees are the MCMC “walkers”. Each tree will have the same number of branches which is fixed throughout a sampling run (i.e. each walker has the same base setup). These branches are our different model types. For example, if you have a signal that is a combination of sine waves and Gaussians. In this case, you have two branches, one for the “sine wave” model and one for the “Gaussian” model. The number of Gaussians or sine waves is accounted
for as the number of “leafs” on each branch. So, if 1 walker has 3 Gaussians and 2 sine waves, we can imagine this as a tree with two branches. The first branch for sine waves has 2 leaves and the second branch as 3 leaves for 3 Gaussians.</p>
<p>When we get to parallel tempering, you can imagine different forests at different temperatures, all having the same number of trees (walkers).</p>
</section>
<section id="Getting-Started-with-the-Ensemble-Sampler">
<h2>Getting Started with the Ensemble Sampler<a class="headerlink" href="#Getting-Started-with-the-Ensemble-Sampler" title="Link to this heading"></a></h2>
<p>Let’s start by running on a simple multivariate Gaussian likelihood:</p>
<div class="math notranslate nohighlight">
\[\ln{\mathcal{L}}\propto -\frac{1}{2}(\vec{x} - \vec{\mu})^T \tilde{C}^{-1} (\vec{x} - \vec{\mu})\]</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gaussian likelihood</span>
<span class="k">def</span> <span class="nf">log_like_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">invcov</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mu</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invcov</span><span class="p">,</span> <span class="n">diff</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<p>Add the initial settings: number of dimensions and number of walkers. Then, generate a covariance matrix for the given dimensionality for the likelihood and a set of means for each component of the Gaussian.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ndim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># mean</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>  <span class="c1"># np.random.rand(ndim)</span>

<span class="c1"># define covariance matrix</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>
<span class="n">invcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next we will build our priors. For simplicity (and based on this problem), we will use a hyper-cube centered on the means with side length set to be <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">lims</span></code>. Eryn requires a class object as the prior with an <code class="docutils literal notranslate"><span class="pre">logpdf</span></code> method (similar to <code class="docutils literal notranslate"><span class="pre">scipy.stats</span></code> distributions). Eryn provides a helper class to aid in this process: <code class="docutils literal notranslate"><span class="pre">`eryn.prior.ProbDistContainer</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/prior.html#prior-container">https://mikekatz04.github.io/Eryn/build/html/user/prior.html#prior-container</a>&gt;`__. This class takes a dictionary as input. In the simplest
form, the keys are integers representing the index into the array of parameters and the values are the associated distributions: <code class="docutils literal notranslate"><span class="pre">{index:</span> <span class="pre">distribution}</span></code>. Eryn has a wrapper for the <code class="docutils literal notranslate"><span class="pre">scipy.stats.uniform</span></code> class that allows you to enter the start and stop points: <code class="docutils literal notranslate"><span class="pre">`eryn.prior.uniform</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/prior.html#eryn.prior.uniform_dist">https://mikekatz04.github.io/Eryn/build/html/user/prior.html#eryn.prior.uniform_dist</a>&gt;`__. For example, if we have a 3D space with uniform priors for all dimensions from -1 to 1, the input dictionary would look
like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>priors_in = {
    0: uniform_dist(-1, 1),
    1: uniform_dist(-1, 1),
    2: uniform_dist(-1, 1)
}
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set prior limits</span>
<span class="n">lims</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">priors_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="o">-</span><span class="n">lims</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lims</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)}</span>
<span class="n">priors</span> <span class="o">=</span> <span class="n">ProbDistContainer</span><span class="p">(</span><span class="n">priors_in</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>In this case, we are not going to use really any of Eryn’s special capabilities. This will allow us to focus on how to navigate the sampler and deal with its output. Then we can add the fun stuff!</p>
<p>The object that directs everything in Eryn (like in <code class="docutils literal notranslate"><span class="pre">emcee</span></code>) is <code class="docutils literal notranslate"><span class="pre">`eryn.ensemble.EnsembleSampler</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/ensemble.html#eryn.ensemble.EnsembleSampler">https://mikekatz04.github.io/Eryn/build/html/user/ensemble.html#eryn.ensemble.EnsembleSampler</a>&gt;`__. It required arguments are number of walkers, dimensionality of inputs (for this simple case this is an integer), the log likelihood function, and the priors. Similar to <code class="docutils literal notranslate"><span class="pre">emcee</span></code>, you can add arguments and keyword arguments to the Likelihood function by providing the <code class="docutils literal notranslate"><span class="pre">args</span></code> and <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> keyword
arguments to the <code class="docutils literal notranslate"><span class="pre">EnsembleSampler</span></code>. In this case, we add the means and inverse of the covariance matrix as extra arguments.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndim</span><span class="p">,</span>
    <span class="n">log_like_fn</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">means</span><span class="p">,</span> <span class="n">invcov</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we will get starting positions for our walkers by sampling from the priors using the <code class="docutils literal notranslate"><span class="pre">rvs</span></code> method of the <code class="docutils literal notranslate"><span class="pre">ProbDistContainer</span></code> and then evaluating the associated Likelihood and prior values. The <code class="docutils literal notranslate"><span class="pre">rvs</span></code> method is also called like in <code class="docutils literal notranslate"><span class="pre">scipy.stats</span></code> distributions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># starting positions</span>
<span class="c1"># randomize throughout prior</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,))</span>

<span class="c1"># check log_like</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
    <span class="n">log_like_fn</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">means</span><span class="p">,</span> <span class="n">invcov</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>

<span class="c1"># check log_prior</span>
<span class="n">log_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
    <span class="n">priors</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_prior</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[-30.69858605 -27.88613553 -10.22294092 -14.70569247 -18.96300942
 -40.24777582 -18.73441074 -24.83741982 -29.01040764 -27.8427905
 -15.6395355  -37.63324244 -37.32945619 -23.65755241 -14.71578138
 -17.41587351 -10.60372232 -14.78508305 -16.44610878 -14.65807937
 -10.96569731 -21.07245692 -21.71012131 -11.7938995  -26.68678623
 -10.56139796 -21.07206293 -15.22766639 -21.70138195 -21.66486977
 -12.67496753 -16.03289018 -29.46929288 -26.72131899 -44.24698912
 -21.3584848  -19.77366496 -28.72150734  -5.84518648 -33.37118884
 -36.15731891 -25.26041351 -25.57594664 -12.25802303 -22.37039294
 -31.88982593 -15.35309536 -24.45627855 -22.46651653 -23.11210745
 -25.31311317 -14.36123373 -23.67409531 -23.41272599 -34.51272062
 -13.40386882 -42.6083427  -10.3819265  -33.56151466 -19.79275524
 -10.09464227 -17.63670509 -15.88594767  -1.5583328  -38.33786195
 -10.04251137 -22.92432228 -26.5383962  -29.02898281 -34.39747766
 -29.93610511 -43.67631032 -37.6288042  -26.57863213 -12.43201382
 -21.71339587 -24.98065915 -22.34629761 -28.53454745 -20.72808992
 -23.58751379 -13.39368888 -12.15662608 -32.82365756  -8.14075088
 -26.22668818 -20.43301692  -8.79050623 -23.10278803 -16.10581548
 -38.66327643 -21.96839538 -19.91765459 -10.73450427 -13.25399003
 -11.51642261 -12.99636574 -21.3527218  -33.90758502 -35.26045709]
[-11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546]
</pre></div></div>
</div>
<p>Because we are in the unit cube, the prior values are constant.</p>
<p>Now, we can run the sampler using the <code class="docutils literal notranslate"><span class="pre">run_mcmc</span></code> method on the <code class="docutils literal notranslate"><span class="pre">EnsembleSampler</span></code> class. It first takes as an argument an array of the starting positions (or a <code class="docutils literal notranslate"><span class="pre">State</span></code> object which we will cover below). We also must provide the number of steps as the second argument. Helpful kwargs (not all inclusive):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">burn</span></code>: Perform a burn in for a certain number of proposals.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">progress</span></code>: If <code class="docutils literal notranslate"><span class="pre">True</span></code>, show the progress as the sampler runs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">thin_by</span></code>: How much to thin the chain directly before storage.</p></li>
</ul>
<p>The total number of proposals the sampler will do is <code class="docutils literal notranslate"><span class="pre">nsteps</span> <span class="pre">*</span> <span class="pre">thin_by</span></code>. It will store <code class="docutils literal notranslate"><span class="pre">nsteps</span></code> samples.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsteps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="c1"># burn for 1000 steps</span>
<span class="n">burn</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># thin by 5</span>
<span class="n">thin_by</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="n">thin_by</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████████████████████████████| 100/100 [00:00&lt;00:00, 247.07it/s]
100%|██████████████████████████████████████| 2500/2500 [00:09&lt;00:00, 261.19it/s]
</pre></div></div>
</div>
<p>Similar to <code class="docutils literal notranslate"><span class="pre">emcee</span></code>, all of the sampler information is stored in a backend object. In the default case, this backend is <code class="docutils literal notranslate"><span class="pre">`eryn.backends.Backend</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/backend.html#eryn.backends.Backend">https://mikekatz04.github.io/Eryn/build/html/user/backend.html#eryn.backends.Backend</a>&gt;`__. To retrieve the samples from the backend, you call the <code class="docutils literal notranslate"><span class="pre">get_chain</span></code> method. This will return a dictionary with keys at the omdel names and a 5-dimensional array per model, which can be intimidating. We will cover that array just below. For now, just focus on
the output of the sampler.</p>
<p>We will first generate corner plot. In this initial example, we have not defined branch names, therefore, the sampler has assigned our problem default branch names <code class="docutils literal notranslate"><span class="pre">model_0</span></code>,…,<code class="docutils literal notranslate"><span class="pre">model_n</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;model_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>
<span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">truths</span><span class="o">=</span><span class="n">means</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_22_0.png" src="../_images/tutorial_Eryn_tutorial_22_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_22_1.png" src="../_images/tutorial_Eryn_tutorial_22_1.png" />
</div>
</div>
<p>Now we will plot the chains.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### Chains</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">walk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;model_0&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_24_0.png" src="../_images/tutorial_Eryn_tutorial_24_0.png" />
</div>
</div>
</section>
<section id="Backend-Objects">
<h2>Backend Objects<a class="headerlink" href="#Backend-Objects" title="Link to this heading"></a></h2>
<p>Backends are where all of the information in the sampler is stored as it runs. It is from these backends that samples are retrieved for plotting. You can find the documentation for the Backend objects <a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/backend.html#backends">here</a>. Here, we will go through the most commonly used functions from the backend: * <code class="docutils literal notranslate"><span class="pre">get_chain</span></code>: retrieve all of the samples stored over the course of the sampling run. * <code class="docutils literal notranslate"><span class="pre">get_log_like</span></code>: retrieve the log of the Likelihood
for each sample. * <code class="docutils literal notranslate"><span class="pre">get_log_prior</span></code>: retrieve the log of the prior for each sample. * <code class="docutils literal notranslate"><span class="pre">get_a_sample</span></code>: retrieve a state object from a specific iteration. <code class="docutils literal notranslate"><span class="pre">get_last_sample</span></code> may be more common. It is just a specific example of <code class="docutils literal notranslate"><span class="pre">get_a_sample</span></code> for the last sample.</p>
<p>Many (but not all) of the methods from the backend object are also raised to the level of sampler. So you can either call <code class="docutils literal notranslate"><span class="pre">EnsembleSampler.backend.method</span></code> or <code class="docutils literal notranslate"><span class="pre">EnsembleSampler.method</span></code> and it will be equivalent.</p>
<p>Common properties to get from the backend: * <code class="docutils literal notranslate"><span class="pre">shape</span></code>: returns a dictionary with keys for each branch name and values as tuples representing the specific shape for each model (this shape will not include the <code class="docutils literal notranslate"><span class="pre">nsteps</span></code> outer dimension. * <code class="docutils literal notranslate"><span class="pre">iteration</span></code>: number of stored iterations in the backend.</p>
<p>Now we will get the likelihood and prior. Notice the shape of the Likelihood is <code class="docutils literal notranslate"><span class="pre">(nsteps,</span> <span class="pre">ntemps,</span> <span class="pre">nwalkers)</span></code> (in this example we have 1 temperature). This will always be the shape of quantities that are a single value per walker (e.g. Likelihood, prior, posterior).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ll</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_log_like</span><span class="p">()</span>
<span class="n">lp</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_log_prior</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of iterations </span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># equivalent to ensemble.get_log_like() and ensemble.get_log_prior()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ll</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of iterations 500
(500, 1, 100) [[[-1.05297225 -2.81695595 -0.80839791 ... -1.30449907 -2.65001331
   -1.72492908]]

 [[-3.51878996 -0.89787788 -4.49356178 ... -4.65518146 -3.7436319
   -1.66068016]]

 [[-2.03059694 -1.49585829 -3.90577462 ... -1.04656098 -2.0396035
   -0.80658449]]

 ...

 [[-1.73887276 -2.27535667 -1.36789573 ... -1.19099689 -2.72232295
   -5.43958501]]

 [[-1.44427868 -1.05581352 -4.30749439 ... -1.85688564 -2.11343788
   -2.24766066]]

 [[-0.6654815  -2.28154314 -2.00102494 ... -1.6139005  -1.08899932
   -2.1398411 ]]] [[[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 ...

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]]
</pre></div></div>
</div>
<section id="5-dimensional-Arrays">
<h3>5-dimensional Arrays<a class="headerlink" href="#5-dimensional-Arrays" title="Link to this heading"></a></h3>
<p>The chain information is returned as a dictionary with keys as the branch names and values as 5-dimensional arrays: <code class="docutils literal notranslate"><span class="pre">(nsteps,</span> <span class="pre">ntemps,</span> <span class="pre">nwalkers,</span> <span class="pre">nleaves_max,</span> <span class="pre">ndim)</span></code>. For clarity: * nsteps: number of sampler iterations stored (time evolution of each forest) * ntemps: number of temperatures (which forest you are in) * nwalkers: number of walkers (which tree) * nleaves_max: maximum number of model counts or leaves for each specific branch. * ndim: number of parameters describing a single
model or leaf.</p>
<p>In our simple example, we have 1 temperature and our maximum leaf count is 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># getting the chain</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()</span>

<span class="c1"># same as</span>
<span class="c1"># samples = enseble.backend.get_chain()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="n">samples</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;model_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;dict&#39;&gt; dict_keys([&#39;model_0&#39;]) (500, 1, 100, 1, 5)
</pre></div></div>
</div>
<p>We can also get the shape information direct from the backend:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;model_0&#39;: (1, 100, 1, 5)}
</pre></div></div>
</div>
</section>
</section>
<section id="State-Objects">
<h2>State Objects<a class="headerlink" href="#State-Objects" title="Link to this heading"></a></h2>
<p>Now, we are going to look at <code class="docutils literal notranslate"><span class="pre">`State</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/state.html#eryn.state.State">https://mikekatz04.github.io/Eryn/build/html/user/state.html#eryn.state.State</a>&gt;`__ objects. They carry the current information throughout the sampler about the current state of the sampler. In our simple example, we can examine the current coordinates, likelihood, and prior values.</p>
<p>Output from the sampler above is the last state of the sampler <code class="docutils literal notranslate"><span class="pre">out</span></code>. This will include any additional objects passed through the sampler like <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> objects that we will explain below.</p>
<p>Another way to retrieve the last state is from the backend. That is what we will do here. However, please note, that supplimental information (discussed below) is not stored in the backend, so the state that is returned from the backend will have information that is stored in the backend, but not supplimental information that was passed through the sampler at runtime.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">last_state</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_last_sample</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">last_state</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;eryn.state.State&#39;&gt;
</pre></div></div>
</div>
<p>We can access the Likelihood and prior values as <code class="docutils literal notranslate"><span class="pre">State.log_like</span></code> and <code class="docutils literal notranslate"><span class="pre">State.log_prior</span></code>. We can also ask the state to give use the posterior probability with the <code class="docutils literal notranslate"><span class="pre">get_log_posterior</span></code> method. Note that shape of these values is <code class="docutils literal notranslate"><span class="pre">(ntemps,</span> <span class="pre">nwalkers)</span></code>. This is because <code class="docutils literal notranslate"><span class="pre">State</span></code> objects represent one moment in time in the sample, so they do not have the <code class="docutils literal notranslate"><span class="pre">nsteps</span></code> outer dimension that the backend has.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">log_like</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">log_prior</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">get_log_posterior</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 100) [[-0.6654815  -2.28154314 -2.00102494 -4.41852808 -1.87391204 -3.05035603
  -1.47197889 -3.04722716 -3.8519063  -2.53028792 -1.47895075 -0.91435392
  -4.67615627 -6.59494035 -3.09579563 -2.31956089 -3.61486196 -1.12447462
  -2.1692713  -4.54813706 -5.47761491 -1.81600973 -2.57141612 -3.18369399
  -8.03114163 -4.03929851 -1.37835437 -1.41370852 -2.04192051 -4.24060107
  -1.81791365 -1.43145056 -1.01976309 -1.08419629 -3.29498179 -2.08090042
  -3.03457142 -0.97839311 -1.45783438 -0.54860516 -0.39096809 -1.63453914
  -2.05034555 -1.13275529 -2.13057916 -3.21847262 -2.14804885 -2.15556008
  -1.92686111 -1.99795709 -0.35164059 -1.21098077 -1.21647944 -1.15304968
  -3.4313149  -4.70693915 -1.4318716  -4.84488379 -2.02338003 -2.07328961
  -2.98861309 -1.0448529  -4.76536477 -1.86707428 -1.24040534 -1.52161672
  -0.93361207 -1.10290796 -1.69669336 -0.98189704 -5.90223547 -3.3408396
  -2.12094704 -3.14709346 -0.37990706 -1.48720061 -3.15361028 -1.1595534
  -1.80055637 -1.59197714 -3.34129599 -1.36805722 -2.01708067 -3.58699943
  -2.32689704 -2.58811303 -2.7197202  -2.05348442 -1.2112424  -1.3357544
  -1.65449106 -1.68322549 -1.04792421 -1.13391508 -2.31811812 -2.46163754
  -5.10129065 -1.6139005  -1.08899932 -2.1398411 ]] [[-11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546]] [[-12.178406967597018 -13.794468601537229 -13.51395040804473
  -15.931453545910662 -13.386837504796224 -14.563281497846829
  -12.984904356428126 -14.560152628566094 -15.364831763416989
  -14.043213387296886 -12.991876210506318 -12.427279383435607
  -16.18908173602542 -18.107865819910735 -14.608721090901623
  -13.832486351401688 -15.12778742254714 -12.637400087040206
  -13.682196761468905 -16.061062522948745 -16.99054037739138
  -13.328935193719195 -14.084341581952058 -14.696619458753926
  -19.544067098137223 -15.552223973129747 -12.89127983919111
  -12.926633980338917 -13.55484597643607 -15.753526531972273
  -13.330839113958634 -12.944376020031633 -12.532688554298963
  -12.597121756200298 -14.807907257937872 -13.593825884034455
  -14.547496880273862 -12.491318574369066 -12.970759842526956
  -12.061530625801362 -11.903893550359193 -13.147464607768942
  -13.563271019780707 -12.64568075132453 -13.643504626290895
  -14.731398085093454 -13.660974318785833 -13.668485545961143
  -13.439786571171963 -13.510882553516781 -11.864566059032157
  -12.72390623089636 -12.729404901485783 -12.665975147003136
  -14.94424036264724 -16.219864618156716 -12.944797066539389
  -16.357809250310932 -13.536305491515654 -13.586215078293383
  -14.501538559296131 -12.557778368205309 -16.278290231060463
  -13.37999974857351 -12.753330808148338 -13.034542185913606
  -12.44653753837222 -12.61583342786152 -13.209618824491073
  -12.494822509135583 -17.415160934688622 -14.8537650614948
  -13.633872503903893 -14.66001892478048 -11.892832526613594
  -13.000126072062562 -14.666535740104562 -12.672478860022272
  -13.313481837705911 -13.104902607647315 -14.854221450723335
  -12.880982689335216 -13.530006134397748 -15.099924895847023
  -13.839822509144446 -14.101038497292365 -14.232645664310798
  -13.566409885481924 -12.724167865929159 -12.848679866185286
  -13.167416523641707 -13.196150950789018 -12.560849676395932
  -12.646840543492647 -13.831043581839076 -13.974563002223718
  -16.614216117226597 -13.126825968142406 -12.601924782141412
  -13.65276656606936]]
</pre></div></div>
</div>
<section id="Branches">
<h3>Branches<a class="headerlink" href="#Branches" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">State</span></code> objects store quantities at are single values per walker directly in the state as shown above (e.g. <code class="docutils literal notranslate"><span class="pre">State.log_like</span></code>). Information that gets down to the individual branch (or model type) level is stored in a <code class="docutils literal notranslate"><span class="pre">`Branch</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/state.html#eryn.state.Branch">https://mikekatz04.github.io/Eryn/html/user/state.html#eryn.state.Branch</a>&gt;`__ object. These <code class="docutils literal notranslate"><span class="pre">Branch</span></code> objects are stored in a dictionary within the <code class="docutils literal notranslate"><span class="pre">State</span></code> object with keys as branch names and values as the <code class="docutils literal notranslate"><span class="pre">Branch</span></code> object associated with that branch name. The
branch objects can be accessed as <code class="docutils literal notranslate"><span class="pre">state.branches[model_name]</span></code>. With in the branch object, the coordinates are stored. A few other things are stored, but we will get to that later. If you want a dictionary with keys at the branch names and values as the current coordinates, you can also use the property: <code class="docutils literal notranslate"><span class="pre">state.branches_coords</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">last_state</span><span class="o">.</span><span class="n">branches</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;model_0&#39;: &lt;eryn.state.Branch at 0x134b34800&gt;}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">last_state</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;model_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span>

<span class="c1"># same as</span>
<span class="c1"># last_state.branches_coords[&quot;model_0&quot;]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[[[ 0.78336101, -0.50304083, -0.16554043,  0.38717246,
          -0.53567929]],

        [[ 1.67992539,  0.45789611,  0.71044046,  0.99561671,
          -0.18785587]],

        [[ 1.58942687, -0.98468048, -0.23409897, -0.34754982,
           0.5749637 ]],

        [[-1.51043746,  1.46761376, -1.36652826,  0.13575554,
           1.58616381]],

        [[ 0.56687718, -0.71412812, -1.07272873,  0.90290266,
          -0.9749437 ]],

        [[-0.26148892, -0.32754323,  2.05336273,  0.43505825,
           1.23267062]],

        [[-0.11388586,  0.97965383,  1.18803374, -0.55536628,
           0.50140833]],

        [[ 0.97231495, -1.80168105, -0.87750463,  0.55941876,
           0.9055604 ]],

        [[ 0.93206222,  0.61099548,  0.22893838, -0.06397951,
           2.53085973]],

        [[ 1.78123828,  0.29397075,  0.87720694, -0.51235873,
          -0.87712242]],

        [[-0.0915609 , -0.06094217,  0.39300579,  0.27838045,
          -1.6473782 ]],

        [[ 0.6848448 ,  0.37394608,  0.43214013,  0.80375073,
          -0.62217316]],

        [[ 1.78087387, -0.37379556, -1.70695828,  0.98429392,
          -1.46919589]],

        [[ 0.87912662,  0.80736483,  2.84535279, -1.02691072,
          -1.61697279]],

        [[-1.59413254, -1.14139239, -0.70216385,  0.56814835,
           1.23763059]],

        [[-1.8783785 , -0.93419666,  0.25561706, -0.41370698,
          -0.03998814]],

        [[-0.43668379, -0.39311608, -0.07642243,  2.43586086,
           0.97223065]],

        [[ 0.00745957, -0.21236731,  0.23184676,  0.8907263 ,
           1.16475211]],

        [[-1.7308126 ,  0.62439654,  0.69996634,  0.52028448,
          -0.43853217]],

        [[-2.30865891,  0.92696939, -0.98209765,  0.4834703 ,
          -1.30722477]],

        [[ 2.07144626, -0.56432505, -0.29089771,  1.32751881,
           2.1210728 ]],

        [[ 0.25274812,  0.9270326 , -0.58971747,  0.75561133,
           1.33792123]],

        [[ 0.05336995, -1.51405245,  0.06533858, -0.93630816,
          -1.40238616]],

        [[ 0.10136621, -1.01709496,  0.08910818, -0.52223649,
           2.2454308 ]],

        [[-0.86197169,  3.73127788,  1.07000261, -0.29443113,
          -0.40651963]],

        [[-1.81087754, -1.31763714,  1.12761906, -0.55144102,
          -1.21964748]],

        [[ 0.72082232, -0.66783269, -0.61110439, -0.05759876,
          -1.18926752]],

        [[-0.31039828, -0.84006455, -0.7555078 , -0.88418758,
           0.82023276]],

        [[-1.15032279, -1.28216431,  0.19945317,  0.9670416 ,
          -0.37643346]],

        [[-0.20656978, -1.09247869, -0.83026592, -0.29333812,
          -2.54354725]],

        [[ 0.0506733 ,  1.58235446, -1.0591977 , -0.01318246,
          -0.08567564]],

        [[ 1.00402466, -1.09280401, -0.57272931, -0.10612996,
          -0.56686201]],

        [[ 0.63470563, -0.29598879,  0.03616789,  1.20713821,
          -0.3009565 ]],

        [[ 0.69564655,  0.26928194,  1.15389273,  0.12383051,
           0.51493035]],

        [[-1.79119556,  0.69120098,  0.01019032, -1.21449347,
           1.19529285]],

        [[ 0.39078543,  1.32386668,  1.4771604 ,  0.02665296,
          -0.27157202]],

        [[ 1.66344411,  1.40855699, -0.2227286 , -0.03021349,
           1.12585205]],

        [[ 0.0358304 ,  0.67413575, -0.6791267 , -0.17160254,
           1.00517803]],

        [[-0.66454531,  0.44931894,  1.2731242 ,  0.80140622,
           0.09520302]],

        [[ 0.08417592, -0.2045363 , -0.81677496,  0.60685038,
           0.11358217]],

        [[-0.41939285,  0.56655054, -0.45246425,  0.12320174,
          -0.25527187]],

        [[ 0.02585738,  1.4670955 ,  0.71912218,  0.7720434 ,
          -0.05341122]],

        [[ 1.29611737,  0.1748023 ,  0.4372776 , -0.68897449,
          -1.3131327 ]],

        [[ 0.24317085,  0.05633037,  0.50847769, -1.16816417,
          -0.76160903]],

        [[-0.43456796,  0.81744538,  0.64783055,  1.33848598,
          -1.09218265]],

        [[-0.19003503,  1.0901105 , -1.68079509, -0.42874181,
           1.48445254]],

        [[-0.09533596,  1.1585624 , -0.28324105,  1.41256148,
          -0.93230171]],

        [[ 0.30259333, -1.2291636 ,  1.14969874,  1.02255485,
          -0.58419916]],

        [[-0.4221966 ,  0.85477946,  0.25227351,  0.96312104,
          -1.39770535]],

        [[-1.0401763 ,  0.6414978 ,  0.55821906, -0.14829119,
          -1.47269454]],

        [[-0.10152982,  0.38256367,  0.08807142,  0.43429676,
           0.59181726]],

        [[ 0.05120369, -0.77512143,  1.14463123, -0.23983033,
           0.67143671]],

        [[ 1.50082842, -0.30584941,  0.20683388, -0.03483413,
           0.20720856]],

        [[-1.08598898,  0.22080208, -0.64865562,  0.40682697,
           0.70122139]],

        [[-0.64175924, -1.58143259,  0.89952925,  1.54536517,
          -0.86749033]],

        [[ 1.06019685, -0.04449809,  1.47050671,  1.04282887,
          -2.24454869]],

        [[ 1.32891118,  0.38437228, -0.71091403, -0.65667314,
           0.11566271]],

        [[-1.52706537,  0.56474267, -0.76715602, -2.42312996,
           0.76080056]],

        [[-1.67036294, -0.28564342, -0.21110799, -0.14839688,
          -1.05283774]],

        [[ 0.05478405, -0.08082125,  0.1447414 , -1.98462828,
           0.42112513]],

        [[-1.21974939, -1.10592271,  1.67658838, -0.49570422,
           0.45793154]],

        [[-1.02752867, -0.5590723 , -0.54126603, -0.48664511,
          -0.43764875]],

        [[ 0.66773172,  0.82481843, -0.15349943,  2.88049842,
          -0.28931849]],

        [[-1.31243376,  1.3452211 ,  0.40682334,  0.18493076,
           0.04839187]],

        [[ 0.50253895,  0.19130782,  0.11088476,  0.56778619,
          -1.36271421]],

        [[ 0.5242914 , -0.99162198,  0.9547818 ,  0.25692932,
          -0.89856378]],

        [[ 0.15281554,  0.77735714, -1.11311344, -0.01051167,
           0.02134045]],

        [[ 0.06119311,  1.17510522, -0.52670296, -0.42278451,
          -0.60418234]],

        [[ 0.24963427,  1.1611201 ,  1.10664802, -0.70071643,
          -0.51691024]],

        [[ 0.89998806, -0.3590725 , -0.0173904 ,  0.94144735,
           0.37182924]],

        [[ 1.37866043, -1.28597385, -0.24976022,  0.42612563,
           2.82950074]],

        [[ 1.72487348, -0.00682858, -1.25268318,  1.29240179,
           0.68332019]],

        [[-0.05155055, -1.9316834 ,  0.34874628, -0.4050601 ,
           0.47131539]],

        [[-0.68665177, -1.32277562,  1.62515034, -1.04049481,
           0.59094657]],

        [[ 0.29061988,  0.28060227,  0.45655932, -0.60961052,
           0.12862806]],

        [[-1.0491748 , -0.19942752, -0.27318093,  0.79095823,
          -1.06471564]],

        [[-1.32490203, -2.01371249, -0.69586741, -0.07780255,
           0.08082376]],

        [[ 0.902882  , -0.40395368, -0.57161503, -0.6188732 ,
           0.79434534]],

        [[ 1.33174975, -0.08962046, -0.40607314,  1.28465644,
          -0.0654673 ]],

        [[ 0.99906271, -1.14535375, -0.31550719,  0.49069006,
          -0.73052807]],

        [[-1.31724964,  0.01639082, -0.97773904,  1.77949826,
           0.90806883]],

        [[ 0.60840415,  0.35765918,  1.09470711,  0.24921034,
           0.98871092]],

        [[ 1.15249127, -1.04587488,  0.68114623, -0.44485005,
           0.97479187]],

        [[-0.41527236,  1.18904736, -1.55784624, -1.77663656,
           0.06626997]],

        [[-0.69748913,  0.91203846,  0.65645409,  0.67068651,
           1.56675987]],

        [[ 0.13570414,  0.561949  , -0.00650889,  2.20041901,
          -0.01172908]],

        [[ 0.006941  , -1.27228794, -0.85989137,  1.46663793,
          -0.96448725]],

        [[-1.49410352, -0.02103752, -0.89929408,  0.99124781,
          -0.28788692]],

        [[ 1.21738227, -0.20578794,  0.62613854, -0.54711243,
          -0.45468127]],

        [[-1.35998576,  0.23620079,  0.19631993,  0.81886101,
          -0.23891811]],

        [[-0.32009865, -0.99200186, -0.58326714,  1.2244503 ,
          -0.61884746]],

        [[ 0.30593953, -0.54655862, -1.54046119,  0.45128582,
          -0.63043325]],

        [[ 0.92726937,  0.10223362,  0.89663029,  0.12669414,
           0.63684452]],

        [[-0.74616171,  0.41006412, -0.4589307 ,  0.09501266,
          -1.15033712]],

        [[ 0.21188577, -0.69703418,  0.09822929,  1.27225746,
           1.57391104]],

        [[-0.3775653 ,  1.3247288 , -1.12052205, -0.0951038 ,
          -1.32710163]],

        [[-2.55808909,  0.61767066,  0.28774531,  1.08037741,
           1.42380889]],

        [[-0.05488234,  1.12340336,  0.8862303 , -0.52472562,
           0.9497435 ]],

        [[-0.35200129,  0.36531645,  0.22484955,  1.08386021,
           0.83386291]],

        [[-1.83839054,  0.67436706, -0.56586041,  0.24858485,
           0.2514738 ]]]])
</pre></div></div>
</div>
</section>
</section>
<section id="Parallel-Tempering">
<h2>Parallel Tempering<a class="headerlink" href="#Parallel-Tempering" title="Link to this heading"></a></h2>
<p>Adding tempering to our problem is straight forward. It will effectively just take the <code class="docutils literal notranslate"><span class="pre">ntemps</span></code> dimension that was 1 above and stretch it to the number of temperatures desired. We add tempering information by providing the <code class="docutils literal notranslate"><span class="pre">tempering_kwargs</span></code> argument to the <code class="docutils literal notranslate"><span class="pre">EnsembleSampler</span></code>. The tempering kwargs documentation can be found here because they are the <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> that go into the initialization of the temperature controller:
<code class="docutils literal notranslate"><span class="pre">`eryn.moves.tempering.TemperatureControl</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/temper.html#eryn.moves.tempering.TemperatureControl">https://mikekatz04.github.io/Eryn/html/user/temper.html#eryn.moves.tempering.TemperatureControl</a>&gt;`__.</p>
<p>The simplest thing to do is to provide the number of temperatures. In this case, we just pass <code class="docutils literal notranslate"><span class="pre">ntemps</span></code> in a dictionary. You can also provide a direct array of <code class="docutils literal notranslate"><span class="pre">betas</span></code> (inverse temperatures). Under the hood, if only <code class="docutils literal notranslate"><span class="pre">ntemps</span></code> is passed (not <code class="docutils literal notranslate"><span class="pre">betas</span></code>), the sampler will use the <code class="docutils literal notranslate"><span class="pre">`eryn.moves.tempering.make_ladder</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/temper.html#eryn.moves.tempering.make_ladder">https://mikekatz04.github.io/Eryn/html/user/temper.html#eryn.moves.tempering.make_ladder</a>&gt;`__ function. We will go all thr way through to the MCMC run. Notice that we are once
again just passing <code class="docutils literal notranslate"><span class="pre">coords</span></code> as an array to start the sampling. We could also pass a <code class="docutils literal notranslate"><span class="pre">State</span></code> object.</p>
<p>What does tempering actual do? The inverse temperature, <span class="math notranslate nohighlight">\(\beta=1/T\)</span>, is attached as an exponent on the Likelihood. The posterior probability as a function of inverse temperature is given by,</p>
<div class="math notranslate nohighlight">
\[\pi_\beta(\vec{\theta}, \mathcal{M})\propto (\mathcal{L}(\vec{\theta}, \mathcal{M}))^\beta p(\vec{\theta},\mathcal{M}).\]</div>
<p>If <span class="math notranslate nohighlight">\(T=1\rightarrow \beta=1\)</span>, we are probing our TARGET distribution.</p>
<p>If <span class="math notranslate nohighlight">\(T=\infty\rightarrow \beta=0\)</span>, we are probing the PRIOR distribution. In this case, the Likelihood surface is effectively flat.</p>
<p>Temperatures in between represent the gradual flattening of the target Likelihood surface towards the flat surface at infinite temperature. During sampling, we look at the log of the Likelihood, so the inverse temperature becomes a multiplicative factor:</p>
<div class="math notranslate nohighlight">
\[\ln\pi_\beta(\vec{\theta}, \mathcal{M})\propto\beta\ln\mathcal{L}(\vec{\theta}, \mathcal{M})\]</div>
<p>Tempering is useful for multimodal distributions and to improve mixing in your chains. This mixing is created by swapping between rungs on our temperature ladder. After each sampler step, swaps are proposed starting at the two highest temperatures and iterating down until we reach the two lowest temperatures. This ensures as higher temperature chains find better Likelihood values, these values and positions are passed toward the cold chain (<span class="math notranslate nohighlight">\(\beta=1\)</span>). The swaps between chains are accepted
with fraction, <span class="math notranslate nohighlight">\(\alpha_T\)</span>:</p>
<div class="math notranslate nohighlight">
\[\alpha_T = \min\left(1, \left[\frac{\mathcal{L_{\beta_1}}}{\mathcal{L_{\beta_2}}}\right]^{\beta_1 - \beta_2}\right).\]</div>
<p>We can see from this how swapping is similar to the Metropolis-Hastings acceptance setup.If <span class="math notranslate nohighlight">\(\beta_1 &gt; \beta_2\)</span> (or <span class="math notranslate nohighlight">\(T_1 &lt;T_2\)</span>), the exponent is positive. In this case, if <span class="math notranslate nohighlight">\(\mathcal{L_{\beta_1}} &gt; \mathcal{L_{\beta_2}}\)</span>, the swap will always be accepted because we want the better likelihood to go to higher <span class="math notranslate nohighlight">\(\beta\)</span> (or lower <span class="math notranslate nohighlight">\(T\)</span>). If <span class="math notranslate nohighlight">\(\mathcal{L_{\beta_1}} &lt; \mathcal{L_{\beta_2}}\)</span>, the swap is accepted with a probability that reflects difference in the
Likelihoods just like discussed above.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># set up problem</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># fill kwargs dictionary</span>
<span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ntemps</span><span class="o">=</span><span class="n">ntemps</span><span class="p">)</span>

<span class="c1"># randomize throughout prior</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,))</span>

<span class="c1"># initialize sampler</span>
<span class="n">ensemble_pt</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndim</span><span class="p">,</span>
    <span class="n">log_like_fn</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">means</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="n">tempering_kwargs</span>
<span class="p">)</span>

<span class="n">nsteps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="c1"># burn for 1000 steps</span>
<span class="n">burn</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="c1"># thin by 5</span>
<span class="n">thin_by</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ensemble_pt</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="n">thin_by</span><span class="p">)</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████| 1000/1000 [00:15&lt;00:00, 66.39it/s]
100%|███████████████████████████████████████| 2500/2500 [00:37&lt;00:00, 66.02it/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;eryn.state.State at 0x134c6b350&gt;
</pre></div></div>
</div>
<p>We can plot our samples at different temperatures and see the differences in action.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntemps</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble_pt</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;model_0&#39;</span><span class="p">][:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>
    <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">truths</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1
2
3
4
5
6
7
8
9
10
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_1.png" src="../_images/tutorial_Eryn_tutorial_48_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_2.png" src="../_images/tutorial_Eryn_tutorial_48_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_3.png" src="../_images/tutorial_Eryn_tutorial_48_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_4.png" src="../_images/tutorial_Eryn_tutorial_48_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_5.png" src="../_images/tutorial_Eryn_tutorial_48_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_6.png" src="../_images/tutorial_Eryn_tutorial_48_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_7.png" src="../_images/tutorial_Eryn_tutorial_48_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_8.png" src="../_images/tutorial_Eryn_tutorial_48_8.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_9.png" src="../_images/tutorial_Eryn_tutorial_48_9.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_48_10.png" src="../_images/tutorial_Eryn_tutorial_48_10.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### Chains</span>
<span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntemps</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">walk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ensemble_pt</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;model_0&#39;</span><span class="p">][:,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_0.png" src="../_images/tutorial_Eryn_tutorial_49_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_1.png" src="../_images/tutorial_Eryn_tutorial_49_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_2.png" src="../_images/tutorial_Eryn_tutorial_49_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_3.png" src="../_images/tutorial_Eryn_tutorial_49_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_4.png" src="../_images/tutorial_Eryn_tutorial_49_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_5.png" src="../_images/tutorial_Eryn_tutorial_49_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_6.png" src="../_images/tutorial_Eryn_tutorial_49_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_7.png" src="../_images/tutorial_Eryn_tutorial_49_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_8.png" src="../_images/tutorial_Eryn_tutorial_49_8.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_9.png" src="../_images/tutorial_Eryn_tutorial_49_9.png" />
</div>
</div>
<p>Likelihoods across temperatures:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ll</span> <span class="o">=</span> <span class="n">ensemble_pt</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_log_like</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ll</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># cold chain and highest temperature chain</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;cold&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;warm&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 10, 100)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x138502ab0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_51_2.png" src="../_images/tutorial_Eryn_tutorial_51_2.png" />
</div>
</div>
</section>
<section id="Add-Reversible-Jump-MCMC-(model-count-uncertainty)">
<h2>Add Reversible Jump MCMC (model count uncertainty)<a class="headerlink" href="#Add-Reversible-Jump-MCMC-(model-count-uncertainty)" title="Link to this heading"></a></h2>
<p>We will now add to our sampler the ability to run with one branch, but a variable number of counts or leaves.</p>
<p>Here we are going to focus on the nested model case where we are just proposing changes in the model count. For more general review on Reversible Jump, see the Eryn paper and sources within.</p>
<p>In nested models, the acceptance probability for proposing to add a source is given by, <span class="math notranslate nohighlight">\(\alpha_\text{nested}\)</span>,</p>
<div class="math notranslate nohighlight">
\[\alpha_\text{nested} = \min\left(1, \frac{\mathcal{L}(\vec{\theta})_{k+1}}{\mathcal{L}(\vec{\theta})_{k}}\frac{p(\vec{\theta}_{+1})}{q(\vec{\theta}_{+1})}\right),\]</div>
<p>where there are <span class="math notranslate nohighlight">\(k\)</span> models to start, <span class="math notranslate nohighlight">\(p(\vec{\theta}_{+1})\)</span> is the prior probability of the added source only (the prior of the other sources cancels in the numerator and denominator), and <span class="math notranslate nohighlight">\(q(\vec{\theta}_{+1})\)</span> is the proposal distribution for the added source, <span class="math notranslate nohighlight">\(\mathcal{L}(\vec{\theta})_k\)</span> is the Likelihood for the position with <span class="math notranslate nohighlight">\(k\)</span> models, and <span class="math notranslate nohighlight">\(\mathcal{L}(\vec{\theta})_{k+1}\)</span> is the Likelihood for the position with <span class="math notranslate nohighlight">\(k + 1\)</span> models.</p>
<p>Reversible Jump proposals usually require specific implementations for each problem. We have one provided RJ proposal where we draw from the prior, which is the simplest and most generic reversible jump proposal for adding a nested model. In this case, the acceptance fraction just reduces to the Likelihood fraction.</p>
<p>For this example, we will look at a set of 1D Gaussian pulses. We will inject a specific number, and then allow the sampler to determine the posterior probability on the model count, as well as the posterior on the parameters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gaussian_pulse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">f_x</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f_x</span>

<span class="k">def</span> <span class="nf">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">gaussian_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>  <span class="c1"># *params -&gt; a, b, c</span>
    <span class="k">return</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">log_like_fn_gauss_pulse</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>

    <span class="n">template</span> <span class="o">=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="n">ll</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">template</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ll</span>


<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">nleaves_max</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">nleaves_min</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">branch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span>

<span class="c1"># define time stream</span>
<span class="n">num</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

<span class="n">gauss_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.9</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">]</span>

<span class="c1"># combine gaussians</span>
<span class="n">injection</span> <span class="o">=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">))</span>

<span class="c1"># set noise level</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># produce full data</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">injection</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">injection</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightskyblue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">injection</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;injection&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x136e66450&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_55_1.png" src="../_images/tutorial_Eryn_tutorial_55_1.png" />
</div>
</div>
<p><strong>Setup our reversible-jump run</strong></p>
<p>The first thing we do is setup our <code class="docutils literal notranslate"><span class="pre">coords</span></code> array. We have seen <code class="docutils literal notranslate"><span class="pre">coords</span></code> before. That array is the same but now <code class="docutils literal notranslate"><span class="pre">nleaves_max</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>.</p>
<p>We also need to setup our <code class="docutils literal notranslate"><span class="pre">inds</span></code> arrays. <code class="docutils literal notranslate"><span class="pre">inds</span></code> is only needed when the dimensionality is changing (or more generally when not all leaves are used). <code class="docutils literal notranslate"><span class="pre">inds</span></code> is a boolean array with shape <code class="docutils literal notranslate"><span class="pre">(ntemps,</span> <span class="pre">nwalkers,</span> <span class="pre">nleaves_max)</span></code>. It indicates which leaves are being used. This allows us to use the array structures while have a variable number of leaves per walker.</p>
<p>We are going to assume we have some knowledge of what is in the data, so we are going to start with 4 leaves for every walker. The burn-in will spread out the walkers both in terms of the parameters and in terms of the number of leaves per walker. Therefore, we are going to make the first four leaves in every walker <code class="docutils literal notranslate"><span class="pre">True</span></code> to indicate 4 sources. We are going to then put coordinates near each of the true Gaussians into <code class="docutils literal notranslate"><span class="pre">coords</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))}</span>

<span class="c1"># this is the sigma for the multivariate Gaussian that sets starting points</span>
<span class="c1"># We need it to be very small to assume we are passed the search phase</span>
<span class="c1"># we will verify this is with likelihood calculations</span>
<span class="n">sig1</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="c1"># setup initial walkers to be the correct count (it will spread out)</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">):</span>
        <span class="c1"># not going to add parameters for these unused leaves</span>
        <span class="k">continue</span>

    <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>

<span class="c1"># make sure to start near the proper setup</span>
<span class="n">inds</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)}</span>

<span class="c1"># turn False -&gt; True for any binary in the sampler</span>
<span class="n">inds</span><span class="p">[</span><span class="s1">&#39;gauss&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<p>Priors are defined per model for a single model. It will take into account multiple models by summing the prior probability over the leaves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># describes priors for all leaves independently</span>
<span class="n">priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>  <span class="c1"># amplitude</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>  <span class="c1"># mean</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">),</span>  <span class="c1"># sigma</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>When reversible jump sampling is run, an RJ move (between model) is performed followed by an “in-model” move for each iteration of the sampler. “In-model” here means the model count is fixed, but the parameters are updated. We pass “in-model” moves to the sampler with the keyword argument <code class="docutils literal notranslate"><span class="pre">moves</span></code>. We pass RJ moves with the <code class="docutils literal notranslate"><span class="pre">rj_moves</span></code> keyword argument.</p>
<p>The stock proposal in <code class="docutils literal notranslate"><span class="pre">Eryn</span></code> is the stretch proposal. This proposal is only directly useful when the dimensionality is fixed. This will be discussed more below. When using reversible jump, we must choose our in-model proposal because the dimensionality is not fixed. Therefore, we choose to move our walkers with the most basic in-model move available: <code class="docutils literal notranslate"><span class="pre">`eryn.moves.GaussianMove</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/moves.html#eryn.moves.GaussianMove">https://mikekatz04.github.io/Eryn/html/user/moves.html#eryn.moves.GaussianMove</a>&gt;`__. For this move you can provide a
covariance matrix that will be used in a multivariate Gaussian to propose new points that are centered on the current points (the means of the multivariate Gaussian will be the current point). This proposal is symmetric.</p>
<p>In this case, we are going to use the stock RJ proposal: <code class="docutils literal notranslate"><span class="pre">`eryn.moves.PriorGenRj</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/moves.html#eryn.moves.DistributionGenerateRJ">https://mikekatz04.github.io/Eryn/html/user/moves.html#eryn.moves.DistributionGenerateRJ</a>&gt;`__. You can either pass this directly or you can set <code class="docutils literal notranslate"><span class="pre">rj_moves</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> (this is the default).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for the Gaussian Move, will be explained later</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">0.00001</span>
<span class="n">cov</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span>

<span class="n">moves</span> <span class="o">=</span> <span class="n">GaussianMove</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>We will now initialize the sampler by adding the branch, tempering, leaf, and move information.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndim</span><span class="p">,</span>
    <span class="n">log_like_fn_gauss_pulse</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ntemps</span><span class="o">=</span><span class="n">ntemps</span><span class="p">),</span>
    <span class="n">nbranches</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_names</span><span class="p">),</span>
    <span class="n">branch_names</span><span class="o">=</span><span class="n">branch_names</span><span class="p">,</span>
    <span class="n">nleaves_max</span><span class="o">=</span><span class="n">nleaves_max</span><span class="p">,</span>
    <span class="n">nleaves_min</span><span class="o">=</span><span class="n">nleaves_min</span><span class="p">,</span>
    <span class="n">moves</span><span class="o">=</span><span class="n">moves</span><span class="p">,</span>
    <span class="n">rj_moves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># basic generation of new leaves from the prior</span>
<span class="p">)</span>
<br/><br/></pre></div>
</div>
</div>
<p>Now we will setup a <code class="docutils literal notranslate"><span class="pre">State</span></code> object and will use the Likelihood (<code class="docutils literal notranslate"><span class="pre">compute_log_like</span></code>) and prior functions (<code class="docutils literal notranslate"><span class="pre">compute_log_prior</span></code>) that are built into the sampler. The Likelihood function in the sampler will check the prior and only run walkers that exist entirely within the prior distribution. We can avoid redoing this computation by passing the prior as the <code class="docutils literal notranslate"><span class="pre">logp</span></code> kwarg to <code class="docutils literal notranslate"><span class="pre">compute_log_like</span></code>. The <code class="docutils literal notranslate"><span class="pre">[0]</span></code> at the end of the line is to grab the log Likelihood and leave behind any blobs.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">log_prior</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_prior</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_like</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span> <span class="n">logp</span><span class="o">=</span><span class="n">log_prior</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># make sure it is reasonably close to the maximum which this is</span>
<span class="c1"># will not be zero due to noise</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="p">)</span>

<span class="c1"># setup starting state</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">log_like</span><span class="o">=</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="o">=</span><span class="n">log_prior</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[-267.48857258 -273.13358068 -272.04356318 -273.41959181 -269.65159976
  -273.45581292 -269.0534354  -269.21480317 -270.17335397 -268.79114293
  -267.97593006 -269.76118281 -268.97477874 -268.96915067 -267.44497304
  -268.55232307 -268.69079155 -269.13611008 -266.317588   -268.19035794]
 [-267.89498107 -271.07519263 -271.01364247 -269.87074404 -271.04982746
  -273.10216287 -270.47561552 -268.73825004 -268.55984235 -267.59669384
  -269.1644275  -268.17686823 -269.5530668  -266.38471516 -270.13810357
  -268.4965744  -271.16336376 -268.37273575 -269.78843561 -266.07926996]
 [-266.65635127 -268.4524668  -269.58696913 -269.88671242 -266.37498437
  -266.44936502 -266.4546787  -272.25432486 -269.746439   -273.53395912
  -268.78432036 -268.09641939 -269.51993913 -270.03690593 -268.47293353
  -270.13166208 -267.3654575  -272.4533991  -267.76589766 -268.67119754]
 [-268.70301053 -268.05419472 -266.85429247 -268.34706671 -272.61170665
  -270.35744037 -267.49130951 -266.41191836 -275.34555909 -267.63796847
  -268.91668611 -268.75395295 -265.89682062 -265.78621765 -269.99614319
  -266.0744601  -267.66910539 -271.02551726 -268.96820568 -272.10089077]
 [-269.36015159 -267.91718124 -266.58033431 -270.98339743 -271.82208208
  -271.73487149 -269.30751278 -269.16895186 -266.30161    -272.80287899
  -269.03261838 -269.48740534 -270.6325905  -267.60035469 -268.2688322
  -274.62821662 -266.26778016 -267.04032577 -270.28884496 -269.45920218]
 [-267.25519775 -267.62892664 -272.26285005 -267.00766373 -269.57983127
  -274.27398717 -268.46784025 -271.09344272 -271.24621424 -267.80982016
  -273.18463057 -268.36312445 -270.59373649 -270.557759   -271.87911261
  -266.02454376 -266.93381068 -278.98378996 -269.83416176 -268.05726244]
 [-267.02005355 -268.09999743 -269.06119558 -268.00971489 -268.12141711
  -268.14986569 -268.14312728 -267.72178265 -271.78486633 -270.33369975
  -268.45148378 -269.87881376 -268.72205688 -270.82850441 -267.57604611
  -266.79122124 -267.35162949 -267.59266883 -267.114322   -270.56048742]
 [-267.67914435 -266.02251242 -266.32624169 -269.16921554 -268.73743926
  -274.21583965 -269.74454528 -269.21673563 -268.68519371 -266.60927311
  -270.20377505 -267.99209023 -269.13139001 -268.27709924 -265.67000643
  -274.6973296  -269.6495672  -269.3549933  -269.01571009 -267.5950623 ]] [[3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]]
</pre></div></div>
</div>
<p>Run the sampler</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsteps</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">last_sample</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████| 1000/1000 [00:36&lt;00:00, 27.08it/s]
100%|███████████████████████████████████████| 2000/2000 [01:13&lt;00:00, 27.27it/s]
</pre></div></div>
</div>
<p>Let’s look at the last sample in terms of the <code class="docutils literal notranslate"><span class="pre">nleaves</span></code> array.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">last_sample</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nleaves</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[4, 4, 3, 4, 4, 3, 4, 4, 4, 4, 3, 4, 4, 4, 4, 3, 4, 3, 5, 3],
       [3, 4, 3, 3, 4, 4, 4, 3, 4, 3, 3, 4, 3, 3, 4, 4, 4, 4, 4, 4],
       [4, 4, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, 3, 5, 3, 4, 5, 4, 3],
       [3, 4, 3, 3, 3, 3, 3, 4, 3, 3, 4, 5, 3, 4, 4, 3, 3, 3, 4, 4],
       [3, 3, 2, 3, 4, 5, 5, 5, 4, 6, 4, 3, 5, 3, 3, 5, 3, 4, 4, 5],
       [4, 4, 3, 3, 2, 2, 2, 4, 3, 3, 3, 3, 3, 2, 5, 3, 2, 3, 3, 4],
       [3, 3, 2, 2, 4, 4, 2, 3, 4, 2, 2, 4, 3, 2, 3, 6, 3, 2, 2, 2],
       [2, 5, 5, 3, 4, 3, 4, 4, 7, 2, 3, 2, 5, 5, 3, 3, 4, 2, 2, 3]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;max ll: </span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_log_like</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">nleaves</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_nleaves</span><span class="p">()[</span><span class="s1">&#39;gauss&#39;</span><span class="p">]</span>
<span class="n">bns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nleaves_max</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="p">)</span>  <span class="c1"># Just to make it pretty and center the bins</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="k">for</span> <span class="n">temp</span><span class="p">,</span> <span class="n">ax_t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">nleaves</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
max ll: -261.2302411532098
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_71_1.png" src="../_images/tutorial_Eryn_tutorial_71_1.png" />
</div>
</div>
<p>To get the samples, we need remove any sources that were not used. We can combine <code class="docutils literal notranslate"><span class="pre">coords</span></code> and <code class="docutils literal notranslate"><span class="pre">inds</span></code> or we can remove anywhere where the backend returns <code class="docutils literal notranslate"><span class="pre">Nan</span></code>. Backends store <code class="docutils literal notranslate"><span class="pre">Nan</span></code> for the coordinates that belong to sources that are not currently used (<code class="docutils literal notranslate"><span class="pre">inds</span> <span class="pre">==</span> <span class="pre">False</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;gauss&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>

<span class="c1"># same as ensemble.get_chain()[&#39;gauss&#39;][ensemble.get_inds()[&#39;gauss&#39;]]</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>

<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>

<span class="k">for</span> <span class="n">mean</span> <span class="ow">in</span> <span class="n">means</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_73_0.png" src="../_images/tutorial_Eryn_tutorial_73_0.png" />
</div>
</div>
</section>
<section id="Add-multiple-branches">
<h2>Add multiple branches<a class="headerlink" href="#Add-multiple-branches" title="Link to this heading"></a></h2>
<p>Now we will add another model to our reversible jump problem. We will add a sine wave model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gaussian_pulse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">f_x</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f_x</span>

<span class="k">def</span> <span class="nf">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">gaussian_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>  <span class="c1"># *params -&gt; a, b, c</span>
    <span class="k">return</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">sine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">f_x</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_x</span>

<span class="k">def</span> <span class="nf">combine_sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>  <span class="c1"># *params -&gt; a, b, c</span>
    <span class="k">return</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">log_like_fn_gauss_and_sine</span><span class="p">(</span><span class="n">params_both</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>

    <span class="n">params_gauss</span><span class="p">,</span> <span class="n">params_sine</span> <span class="o">=</span> <span class="n">params_both</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params_gauss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params_gauss</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params_sine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">combine_sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params_sine</span><span class="p">)</span>

    <span class="n">ll</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">template</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ll</span>


<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">ndims</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="n">nleaves_max</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
<span class="n">nleaves_min</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="n">branch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">]</span>

<span class="c1"># define time stream</span>
<span class="n">num</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

<span class="n">gauss_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.9</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">sine_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">4.6</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span>
<span class="p">]</span>

<span class="c1"># combine gaussians</span>
<span class="n">injection</span> <span class="o">=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">))</span>
<span class="n">injection</span> <span class="o">+=</span> <span class="n">combine_sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">))</span>

<span class="c1"># set noise level</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># produce full data</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">injection</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">injection</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightskyblue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">injection</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;injection&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x135c54e60&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_76_1.png" src="../_images/tutorial_Eryn_tutorial_76_1.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">coords</span></code> and <code class="docutils literal notranslate"><span class="pre">inds</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">])),</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]))</span>
<span class="p">}</span>

<span class="c1"># make sure to start near the proper setup</span>
<span class="n">inds</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1"># this is the sigma for the multivariate Gaussian that sets starting points</span>
<span class="c1"># We need it to be very small to assume we are passed the search phase</span>
<span class="c1"># we will verify this is with likelihood calculations</span>
<span class="n">sig1</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="c1"># setup initial walkers to be the correct count (it will spread out)</span>
<span class="c1"># start with gaussians</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">):</span>
        <span class="c1"># not going to add parameters for these unused leaves</span>
        <span class="k">continue</span>
    <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>
    <span class="n">inds</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># next do sine waves</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">):</span>
        <span class="c1"># not going to add parameters for these unused leaves</span>
        <span class="k">continue</span>
    <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>
    <span class="n">inds</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<br/></pre></div>
</div>
</div>
<p>Priors are defined per model for a single model. It will take into account multiple models by summing the prior probability over the leaves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># describes priors for all leaves independently</span>
<span class="n">priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>  <span class="c1"># amplitude</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>  <span class="c1"># mean</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">),</span>  <span class="c1"># sigma</span>
    <span class="p">},</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>  <span class="c1"># amplitude</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span>  <span class="c1"># mean</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>  <span class="c1"># sigma</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>You can add multiple covariance matrices. One for each branch. We will keep it the same for simplicity.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for the Gaussian Move, will be explained later</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">0.00001</span>
<span class="n">cov</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">factor</span>
<span class="p">}</span>

<span class="n">moves</span> <span class="o">=</span> <span class="n">GaussianMove</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>We will now initialize the sampler by adding the branch, tempering, leaf, and move information.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndims</span><span class="p">,</span>
    <span class="n">log_like_fn_gauss_and_sine</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ntemps</span><span class="o">=</span><span class="n">ntemps</span><span class="p">),</span>
    <span class="n">nbranches</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_names</span><span class="p">),</span>
    <span class="n">branch_names</span><span class="o">=</span><span class="n">branch_names</span><span class="p">,</span>
    <span class="n">nleaves_max</span><span class="o">=</span><span class="n">nleaves_max</span><span class="p">,</span>
    <span class="n">nleaves_min</span><span class="o">=</span><span class="n">nleaves_min</span><span class="p">,</span>
    <span class="n">moves</span><span class="o">=</span><span class="n">moves</span><span class="p">,</span>
    <span class="n">rj_moves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># basic generation of new leaves from the prior</span>
<span class="p">)</span>
<br/><br/></pre></div>
</div>
</div>
<p>Prior, Likelihood, and initial state.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">log_prior</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_prior</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_like</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span> <span class="n">logp</span><span class="o">=</span><span class="n">log_prior</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># make sure it is reasonably close to the maximum which this is</span>
<span class="c1"># will not be zero due to noise</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="p">)</span>

<span class="c1"># setup starting state</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">log_like</span><span class="o">=</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="o">=</span><span class="n">log_prior</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[-229.18441391 -233.51872418 -231.94801463 -235.4050852  -226.670966
  -232.71483467 -229.99148863 -232.40535129 -229.22825659 -230.16495346
  -228.29127145 -228.74374649 -226.49117628 -231.25563257 -228.862688
  -227.44352935 -234.67849744 -231.49859258 -230.65579296 -231.81069992]
 [-227.81377327 -230.13945878 -229.41654888 -227.94783414 -229.31522738
  -229.81615798 -229.78817956 -227.80534798 -231.90524192 -228.65212536
  -230.79128554 -227.40049869 -231.24527916 -234.05736224 -238.63570222
  -231.43650992 -235.70464801 -231.34328242 -228.12956141 -229.26914673]
 [-230.26442866 -226.47503056 -231.56851138 -229.37430551 -228.93271986
  -230.38850202 -232.53092761 -235.03556521 -231.54049548 -229.99913862
  -232.53777598 -228.16530309 -230.35808751 -227.22674918 -226.15827365
  -236.00134375 -235.68397539 -226.24369726 -231.68966882 -227.59454795]
 [-231.95358162 -228.82307944 -235.14353803 -229.14890501 -232.15227879
  -228.64013278 -228.89132475 -234.37202006 -227.71900568 -227.70720334
  -230.98768038 -232.11278035 -228.33877408 -241.12287975 -232.40874977
  -230.84468334 -233.2095918  -230.99834849 -231.10304391 -227.32449253]
 [-229.1865482  -230.04713397 -232.82592779 -229.51721312 -226.95258359
  -230.80694449 -228.14420069 -230.90414617 -233.609932   -228.10522529
  -230.85522437 -229.68349989 -230.10665679 -229.19997595 -234.44616622
  -228.85330281 -234.27875953 -233.58673313 -228.10932674 -234.29296705]
 [-233.95788218 -228.0866977  -233.30264265 -228.82346604 -229.72494204
  -234.28165905 -238.15989341 -234.29506362 -230.50970622 -230.71630602
  -230.12739788 -231.63811447 -233.83828594 -229.67742849 -228.6620161
  -238.63551634 -228.32572285 -228.24280784 -234.38914285 -228.14806505]
 [-229.23356207 -234.67103428 -237.90881138 -233.83466125 -231.34757217
  -229.55405955 -231.77788649 -232.20798465 -229.09701881 -233.44980698
  -226.98678903 -231.26528224 -229.38754856 -231.85794747 -231.22487614
  -234.95102489 -232.95030022 -228.22226315 -231.56264544 -229.59721156]
 [-231.90934207 -234.26628503 -229.59759858 -226.18117692 -228.3581854
  -227.89490619 -232.35931607 -227.58448115 -237.42531875 -233.79614919
  -229.43853536 -232.59733154 -228.00377491 -228.39675954 -233.79924613
  -226.68628461 -228.18445055 -229.21994604 -229.56782994 -230.51977065]] [[-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]]
</pre></div></div>
</div>
<p>Run the sampler</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="o">.</span><span class="n">branches</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;gauss&#39;: &lt;eryn.state.Branch at 0x135c56d20&gt;,
 &#39;sine&#39;: &lt;eryn.state.Branch at 0x135c576b0&gt;}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">last_sample</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████| 1000/1000 [00:55&lt;00:00, 18.07it/s]
100%|███████████████████████████████████████| 5000/5000 [04:22&lt;00:00, 19.08it/s]
</pre></div></div>
</div>
<p>Let’s look at the last sample in terms of the <code class="docutils literal notranslate"><span class="pre">nleaves</span></code> array for both branches in the cold chain.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">last_sample</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nleaves</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last_sample</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nleaves</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [3, 3],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;max ll: </span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_log_like</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">nleaves_gauss</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_nleaves</span><span class="p">()[</span><span class="s1">&#39;gauss&#39;</span><span class="p">]</span>
<span class="n">nleaves_sine</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_nleaves</span><span class="p">()[</span><span class="s1">&#39;sine&#39;</span><span class="p">]</span>
<span class="n">bns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="p">)</span>  <span class="c1"># Just to make it pretty and center the bins</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="k">for</span> <span class="n">temp</span><span class="p">,</span> <span class="n">ax_t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">nleaves_gauss</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bns</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">)</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">nleaves_sine</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bns</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sine&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
max ll: -218.81128464457333
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x138ba86b0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_92_2.png" src="../_images/tutorial_Eryn_tutorial_92_2.png" />
</div>
</div>
<p>To get the samples, we need remove any sources that were not used. We can combine <code class="docutils literal notranslate"><span class="pre">coords</span></code> and <code class="docutils literal notranslate"><span class="pre">inds</span></code> or we can remove anywhere where the backend returns <code class="docutils literal notranslate"><span class="pre">Nan</span></code>. Backends store <code class="docutils literal notranslate"><span class="pre">Nan</span></code> for the coordinates that belong to binaries that are not currently used (<code class="docutils literal notranslate"><span class="pre">inds</span> <span class="pre">==</span> <span class="pre">False</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;gauss&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>

<span class="c1"># same as ensemble.get_chain()[&#39;gauss&#39;][ensemble.get_inds()[&#39;gauss&#39;]]</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>

<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>

<span class="k">for</span> <span class="n">mean</span> <span class="ow">in</span> <span class="n">means</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_94_0.png" src="../_images/tutorial_Eryn_tutorial_94_0.png" />
</div>
</div>
</section>
<section id="Moves">
<h2>Moves<a class="headerlink" href="#Moves" title="Link to this heading"></a></h2>
<p>Moves are generally implemented with the same three-tier structure that originated in <code class="docutils literal notranslate"><span class="pre">emcee</span></code>. For full documentation on all available moves, as well as class inheritance information, see the <a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/moves.html#moves">Move documentation</a>. For implementing customized moves, we recommend using the documentation as well as the various source codes for guidance.</p>
<p>from <code class="docutils literal notranslate"><span class="pre">eryn.moves</span></code>:</p>
<ul class="simple">
<li><p>Base Move Class (<code class="docutils literal notranslate"><span class="pre">Move</span></code>)</p></li>
<li><p>Move Guide (<code class="docutils literal notranslate"><span class="pre">MHMove</span></code>, <code class="docutils literal notranslate"><span class="pre">RedBlueMove</span></code>, <code class="docutils literal notranslate"><span class="pre">ReversibleJumpMove</span></code>, <code class="docutils literal notranslate"><span class="pre">GroupMove</span></code>)</p></li>
<li><p>Proposal Class (e.g. <code class="docutils literal notranslate"><span class="pre">StretchMove</span></code>, <code class="docutils literal notranslate"><span class="pre">GaussianMove</span></code>, <code class="docutils literal notranslate"><span class="pre">GroupStretchMove</span></code>, <code class="docutils literal notranslate"><span class="pre">DistributionGenerateRJ</span></code>).</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">eryn.moves.Move</span></code> class is a base class for all moves. It houses the tempering information class (<code class="docutils literal notranslate"><span class="pre">eryn.moves.TemperatureControl</span></code>), as well as other information and methods that apply universally to most or all moves.</p>
<p>The Move Guides provide the overall computation of the different <strong>types</strong> of moves depending on how they are executed. Their main purpose is to implement the <code class="docutils literal notranslate"><span class="pre">propose(model,</span> <span class="pre">state)</span></code> function. They all return a tuple of updated <code class="docutils literal notranslate"><span class="pre">State</span></code> objects and an boolean array of accepted information.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MHMove</span></code>: These moves move all walkers simultaneously as an in-model move without using any information from current walkers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RedBlueMove</span></code>: These moves move half of the distribution first and then the other half. This allows for parallel updates of moves that use current walkers for move information. This strategy was first proposed in <code class="docutils literal notranslate"><span class="pre">emcee</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GroupMoves</span></code>: These moves can move all walkers at once. They are similar to the <code class="docutils literal notranslate"><span class="pre">RedBlueMove</span></code> but instead of using current walkers, they use a stationary distribution of walkers that does not change each proposal. Ideally, the distribution changes infrequently.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ReversibleJumpMove</span></code>: This class guides Reversible Jump MCMC moves. The key difference to the other moves is that the <code class="docutils literal notranslate"><span class="pre">inds</span></code> array changes adjust the model type and/or count. It is very common in Reversible Jump settings to have to implemement a specific RJ proposal. One of the main goals of <code class="docutils literal notranslate"><span class="pre">Eryn</span></code> is to distill this process down to this step and keep the rest of the sampler apparatus the same between projects.</p></li>
</ul>
<section id="Example-diagonal-covariance-move">
<h3>Example diagonal covariance move<a class="headerlink" href="#Example-diagonal-covariance-move" title="Link to this heading"></a></h3>
<p>When implemented a move at the Proposal Class layer, you only <strong>need</strong> to implement the <code class="docutils literal notranslate"><span class="pre">get_proposal</span></code> method. Look at the call signature from the chosen Move Guide. You can obviously implement more than that.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">eryn.moves</span> <span class="kn">import</span> <span class="n">MHMove</span>

<span class="k">class</span> <span class="nc">NonScaledDiagonalGaussianMove</span><span class="p">(</span><span class="n">MHMove</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_all</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># checks</span>
        <span class="k">for</span> <span class="n">branch_name</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">cov_all</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cov</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># store for later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="n">cov_all</span>

        <span class="c1"># initialize any parent class information</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NonScaledDiagonalGaussianMove</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_proposal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branches_coords</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">branches_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">assert</span> <span class="n">branches_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">new_points</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">branches_coords</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">branches_coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="n">branches_inds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span>

            <span class="c1"># generate sigma from normal distribution</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">)</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">+</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cov</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># symmetric</span>
            <span class="n">new_points</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

            <span class="c1"># this is not necessary as the inds will remove there changes in the parent class</span>
            <span class="c1"># but I put it here to indicate to think about it</span>
            <span class="n">new_points</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>

        <span class="c1"># symmetric</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">factors</span>
</pre></div>
</div>
</div>
</section>
<section id="Gibbs-Sampling">
<h3>Gibbs Sampling<a class="headerlink" href="#Gibbs-Sampling" title="Link to this heading"></a></h3>
<p>There is a very useful setup for Gibbs sampling of parameters in <code class="docutils literal notranslate"><span class="pre">Eryn</span></code>. To use this feature, you can pass information as the <code class="docutils literal notranslate"><span class="pre">gibbs_sampling_setup</span></code> keyword argument to the chosen Move class. It is handled by the base <code class="docutils literal notranslate"><span class="pre">eryn.moves.Move</span></code> class so it is a feature of all proposals.</p>
<p>Gibbs sampling allows the user to sample over a specific set of models or parameters to improve sampling efficiency. For example, sampling in a 100-parameter space may be inefficient, but sampling in 10-dimensional sub-spaces consecutively may be more efficient by increasing the acceptance fraction.</p>
<p>The documentation for the <code class="docutils literal notranslate"><span class="pre">gibbs_sampling_setup</span></code> parameter reads as follows:</p>
<p><code class="docutils literal notranslate"><span class="pre">gibbs_sampling_setup</span></code> (str, tuple, dict, or list, optional) – This sets the Gibbs Sampling setup if desired. The Gibbs sampling setup is completely customizable down to the leaf and parameters. All of the separate Gibbs sampling splits will be run within 1 call to this proposal. If None, run all branches and all parameters. If str, run all parameters within the branch given as the string. To enter a branch with a specific set of parameters, you can provide a 2-tuple with the first entry as
the branch name and the second entry as a 2D boolean array of shape (nleaves_max, ndim) that indicates which leaves and/or parameters you want to run. None can also be entered in the second entry if all parameters are to be run. A dictionary is also possible with keys as branch names and values as the same 2D boolean array of shape (nleaves_max, ndim) that indicates which leaves and/or parameters you want to run. None can also be entered in the value of the dictionary if all parameters are to be
run. If multiple keys are provided in the dictionary, those branches will be run simultaneously in the proposal as one iteration of the proposing loop. The final option is a list. This is how you make sure to run all the Gibbs splits. Each entry of the list can be a string, 2-tuple, or dictionary as described above. The list controls the order in which all of these splits are run. (default: None)</p>
<p>In the following example, we will use Gibbs sampling to run the same multimodel case as above with the sine waves and Gaussian pulses. However, in the example above, for each proposal, both in-model and between-model, all parameters/leaves were updated simultaneously. This means for the in-model step, all parameters for both models were updated simultaneously. In the between-model or RJ step, changes to the leaf counts were also proposed simultaneously for both models. In simple cases, the may
be okay.</p>
<p>Here we will fix the model count of the sine waves to the true value in order to use the stretch proposal on that model. We will still sample over Gaussian pulses with an uncertain model count. We will choose for the sake of example to sample leaf by leaf over the first 2 parameters of the sine wave and then the last one. For the Gaussians, we will sample all the parameters together, but leaf by leaf.</p>
<p>We will also use the <code class="docutils literal notranslate"><span class="pre">CombineMove</span></code> to make sure these all happen one after another.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">ndims</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="n">nleaves_max</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span> <span class="c1"># same min and max means no changing</span>
<span class="n">nleaves_min</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="n">branch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">]</span>

<span class="c1"># define time stream</span>
<span class="n">num</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

<span class="n">gauss_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.9</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">sine_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">4.6</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span>
<span class="p">]</span>

<span class="c1"># combine gaussians</span>
<span class="n">injection</span> <span class="o">=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">))</span>
<span class="n">injection</span> <span class="o">+=</span> <span class="n">combine_sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">))</span>

<span class="c1"># set noise level</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># produce full data</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">injection</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">injection</span><span class="p">))</span>


<span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">])),</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]))</span>
<span class="p">}</span>

<span class="c1"># make sure to start near the proper setup</span>
<span class="n">inds</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1"># this is the sigma for the multivariate Gaussian that sets starting points</span>
<span class="c1"># We need it to be very small to assume we are passed the search phase</span>
<span class="c1"># we will verify this is with likelihood calculations</span>
<span class="n">sig1</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="c1"># setup initial walkers to be the correct count (it will spread out)</span>
<span class="c1"># start with gaussians</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">):</span>
        <span class="c1"># not going to add parameters for these unused leaves</span>
        <span class="k">continue</span>
    <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>
    <span class="n">inds</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># next do sine waves</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">):</span>
        <span class="c1"># not going to add parameters for these unused leaves</span>
        <span class="k">continue</span>
    <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>
    <span class="c1"># inds[&quot;sine&quot;][:, :, nn] = True  # already True</span>


<span class="c1"># describes priors for all leaves independently</span>
<span class="n">priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>  <span class="c1"># amplitude</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>  <span class="c1"># mean</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">),</span>  <span class="c1"># sigma</span>
    <span class="p">},</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>  <span class="c1"># amplitude</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span>  <span class="c1"># mean</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>  <span class="c1"># sigma</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># for the Gaussian Move</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">0.00001</span>
<span class="n">cov</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># pass boolean array of shape (nleaves_max[&quot;gauss&quot;], ndims[&quot;gauss&quot;])</span>
<span class="n">gibbs_sampling_gauss</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">])</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]):</span>
    <span class="n">gibbs_sampling_gauss</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">gauss_move</span> <span class="o">=</span> <span class="n">GaussianMove</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">gibbs_sampling_setup</span><span class="o">=</span><span class="n">gibbs_sampling_gauss</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gauss gibbs setup:&quot;</span><span class="p">,</span> <span class="n">gibbs_sampling_gauss</span><span class="p">)</span>

<span class="n">gibbs_sampling_sine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;sine&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">])</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gibbs_sampling_sine</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gibbs_sampling_sine</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sine gibbs setup:&quot;</span><span class="p">,</span> <span class="n">gibbs_sampling_sine</span><span class="p">)</span>

<span class="n">sine_move</span> <span class="o">=</span> <span class="n">StretchMove</span><span class="p">(</span><span class="n">live_dangerously</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gibbs_sampling_setup</span><span class="o">=</span><span class="n">gibbs_sampling_sine</span><span class="p">)</span>

<span class="n">move</span> <span class="o">=</span> <span class="n">CombineMove</span><span class="p">([</span><span class="n">gauss_move</span><span class="p">,</span> <span class="n">sine_move</span><span class="p">])</span>

<span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndims</span><span class="p">,</span>
    <span class="n">log_like_fn_gauss_and_sine</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ntemps</span><span class="o">=</span><span class="n">ntemps</span><span class="p">),</span>
    <span class="n">nbranches</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_names</span><span class="p">),</span>
    <span class="n">branch_names</span><span class="o">=</span><span class="n">branch_names</span><span class="p">,</span>
    <span class="n">nleaves_max</span><span class="o">=</span><span class="n">nleaves_max</span><span class="p">,</span>
    <span class="n">nleaves_min</span><span class="o">=</span><span class="n">nleaves_min</span><span class="p">,</span>
    <span class="n">moves</span><span class="o">=</span><span class="n">move</span><span class="p">,</span>
    <span class="n">rj_moves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># basic generation of new leaves from the prior</span>
<span class="p">)</span>


<span class="n">log_prior</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_prior</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_like</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span> <span class="n">logp</span><span class="o">=</span><span class="n">log_prior</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># make sure it is reasonably close to the maximum which this is</span>
<span class="c1"># will not be zero due to noise</span>

<span class="c1"># setup starting state</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">log_like</span><span class="o">=</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="o">=</span><span class="n">log_prior</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>

<span class="n">nsteps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">last_sample</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
gauss gibbs setup: [(&#39;gauss&#39;, array([[ True,  True,  True],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False]])), (&#39;gauss&#39;, array([[False, False, False],
       [ True,  True,  True],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False]])), (&#39;gauss&#39;, array([[False, False, False],
       [False, False, False],
       [ True,  True,  True],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False]])), (&#39;gauss&#39;, array([[False, False, False],
       [False, False, False],
       [False, False, False],
       [ True,  True,  True],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False]])), (&#39;gauss&#39;, array([[False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [ True,  True,  True],
       [False, False, False],
       [False, False, False],
       [False, False, False]])), (&#39;gauss&#39;, array([[False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [ True,  True,  True],
       [False, False, False],
       [False, False, False]])), (&#39;gauss&#39;, array([[False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [ True,  True,  True],
       [False, False, False]])), (&#39;gauss&#39;, array([[False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [False, False, False],
       [ True,  True,  True]]))]
sine gibbs setup: [(&#39;sine&#39;, array([[ True,  True, False],
       [False, False, False]])), (&#39;sine&#39;, array([[False, False,  True],
       [False, False, False]])), (&#39;sine&#39;, array([[False, False, False],
       [ True,  True, False]])), (&#39;sine&#39;, array([[False, False, False],
       [False, False,  True]]))]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████████████████████████| 100/100 [00:31&lt;00:00,  3.21it/s]
100%|█████████████████████████████████████████| 500/500 [02:41&lt;00:00,  3.10it/s]
</pre></div></div>
</div>
</section>
<section id="Example:-GroupStretchMove">
<h3>Example: <code class="docutils literal notranslate"><span class="pre">GroupStretchMove</span></code><a class="headerlink" href="#Example:-GroupStretchMove" title="Link to this heading"></a></h3>
<p>The “group stretch move” is a new kind of MCMC proposal that is based on the affine-invariant or “stretch” proposal (<a class="reference external" href="https://emcee.readthedocs.io/en/stable/">emcee</a>). It was first proposed in <a class="reference external" href="https://arxiv.org/abs/2303.02164">arXiv:2303.02164</a>. The purpose of the group stretch proposal is to apply the advantages of the stretch proposal to a more diverse array of situations, e.g. in reversible jump settings where the dimensionality differences render the base stretch proposal unusable.
The stretch proposal proposes a new location, <span class="math notranslate nohighlight">\(Y_k\)</span>, for a current point in the ensemble, <span class="math notranslate nohighlight">\(X_k\)</span>, based on:</p>
<div class="math notranslate nohighlight">
\[X_k = X_j + z\left(X_k - X_j\right),\]</div>
<p>where <span class="math notranslate nohighlight">\(X_j\)</span> is drawn from the remaining ensemble after <span class="math notranslate nohighlight">\(X_k\)</span> is removed (<span class="math notranslate nohighlight">\(X_j\in X_{\{k\}}\)</span>) and z is a random variable drawn from a particular set of possible distributions.</p>
<p>The key part of the <em>base stretch</em> proposal is that <span class="math notranslate nohighlight">\(X_j\)</span> is drawn from the current ensemble of points (excluding <span class="math notranslate nohighlight">\(X_k\)</span>). As the dimensionality changes, this setup becomes ill-defined.</p>
<p>The <em>group stretch</em> proposal changes how we determine <span class="math notranslate nohighlight">\(X_j\)</span> so that it can fit into a more general RJMCMC setup. Rather than drawing it from the current ensemble, a <em>stationary</em> set of “friends” are chosen and stored; these friends “simulate” the posterior distribution taking the place of the remaining ensemble in the <em>base stretch</em> move. The key here is this group stays fixed over many, many proposals.</p>
<p>This setup allows the user to adapt to a given posterior setup. We will repeat our Gaussian pulse example from above to see why the group stretch move is useful. Above, when running RJMCMC examples, we use the <code class="docutils literal notranslate"><span class="pre">GaussianMove</span></code> in a simplified manner. In many numerical applications, this type of move involving a covariance matrix requires tuning. In the case of nested models, like here with Gaussian pulses, the posterior will contain a different mode for each model instance (and potentially for
falsely detected model instances). In this case, it can be hard to tune each covariance matrix in an efficient manner.</p>
<p>Here is how the group stretch will work as a substitute for the <code class="docutils literal notranslate"><span class="pre">GaussianMove</span></code>:</p>
<p>Main idea: we will group leaves (representing 1 pulse each) according to their mean value. Grouping one sample of the ensemble like this will effectively simulate one instance of a posterior draw.</p>
<p>Limiting cases:</p>
<ul class="simple">
<li><p>When there is no confusion between the two pulses and/or how many pulses their are, the group stretch proposal will be very efficient. It will set <span class="math notranslate nohighlight">\(X_j\)</span> properly for each posterior mode so <span class="math notranslate nohighlight">\(X_j\)</span> and <span class="math notranslate nohighlight">\(X_k\)</span> are always found on the same posterior mode (this is the goal).</p></li>
<li><p>When there is a massive amount of confusion, and it is very hard to separate posterior modes, the group stretch will be effectively random. Its usual inherent knowledge of the scales of the posterior modes will be entirely lost.</p></li>
</ul>
<p>During setup:</p>
<ol class="arabic simple">
<li><p>Determine number of friends. Usually set to <span class="math notranslate nohighlight">\(\sim\)</span>number of walkers.</p></li>
<li><p>Setup a <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> object to house indexes of each leaf to its closest friends.</p></li>
</ol>
<p>Before first proposal and after a large number of proposals (<code class="docutils literal notranslate"><span class="pre">setup_friends</span></code>):</p>
<ol class="arabic simple">
<li><p>Take all current leaves in the cold-chain. Flatten this array and sort by the mean parameter. This becomes our stationary distribution of friends.</p></li>
<li><p>For all current leaves at all temperatures, locate which friends are closest to their mean value. With <code class="docutils literal notranslate"><span class="pre">nfriends</span></code><span class="math notranslate nohighlight">\(\sim\)</span><code class="docutils literal notranslate"><span class="pre">nwalkers</span></code>, the stored points will effectively be one current ensemble instance of the posterior distribution.</p></li>
<li><p>Store indexes of these friends in the <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> objects discussed below.</p></li>
</ol>
<p>Before each proposal (<code class="docutils literal notranslate"><span class="pre">fix_friends</span></code>):</p>
<ol class="arabic simple">
<li><p>Fill friend information for any newly activated leaves from RJMCMC that do not have an indicator of its friends yet.</p></li>
</ol>
<p>Drawing the friends at proposal time (<code class="docutils literal notranslate"><span class="pre">find_friends</span></code>):</p>
<ol class="arabic simple">
<li><p>From <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code>, get friend indexes for all current leaves being proposed (<code class="docutils literal notranslate"><span class="pre">s_inds==True</span></code>).</p></li>
<li><p>Randomly choose one of the friends. Set this to <span class="math notranslate nohighlight">\(X_j\)</span>.</p></li>
</ol>
<p>First we will start with setting up the data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># define time stream</span>
<span class="n">num</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

<span class="n">gauss_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">4.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="p">]</span>

<span class="c1"># combine gaussians</span>
<span class="n">injection</span> <span class="o">=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">gauss_inj_params</span><span class="p">)</span>

<span class="c1"># set noise level</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># produce full data</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">injection</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">injection</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightskyblue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">injection</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;injection&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x137cd8260&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_106_1.png" src="../_images/tutorial_Eryn_tutorial_106_1.png" />
</div>
</div>
<p>Now, we will build our <code class="docutils literal notranslate"><span class="pre">GroupStretchMove</span></code> that is based on the mean value of each Gaussian pulse.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">eryn.moves</span> <span class="kn">import</span> <span class="n">GroupStretchMove</span>

<span class="k">class</span> <span class="nc">MeanGaussianGroupMove</span><span class="p">(</span><span class="n">GroupStretchMove</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># make sure kwargs get sent into group stretch parent class</span>
        <span class="n">GroupStretchMove</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_friends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>

        <span class="c1"># store cold-chain information</span>
        <span class="n">friends</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">friends</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># need the copy</span>

        <span class="c1"># take unique to avoid errors at the start of sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">,</span> <span class="n">uni_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">friends</span> <span class="o">=</span> <span class="n">friends</span><span class="p">[</span><span class="n">uni_inds</span><span class="p">]</span>

        <span class="c1"># sort</span>
        <span class="n">inds_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">friends</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">friends</span><span class="p">[</span><span class="n">inds_sort</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">inds_sort</span><span class="p">]</span>

        <span class="c1"># get all current means from all temperatures</span>
        <span class="n">current_means</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">inds</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># calculate their distances to each stored friend</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">current_means</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># get closest friends</span>
        <span class="n">inds_closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfriends</span><span class="p">]</span>

        <span class="c1"># store in branch supplimental</span>
        <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">branch_supplimental</span><span class="p">[</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;inds_closest&quot;</span><span class="p">:</span> <span class="n">inds_closest</span>
        <span class="p">}</span>

        <span class="c1"># make sure to &quot;turn off&quot; leaves that are deactivated by setting their</span>
        <span class="c1"># index to -1.</span>
        <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">branch_supplimental</span><span class="p">[</span><span class="o">~</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;inds_closest&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                <span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfriends</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span>
            <span class="p">)[</span><span class="o">~</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">inds</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">fix_friends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="c1"># when RJMCMC activates a new leaf, when it gets to this proposal, its inds_closest</span>
        <span class="c1"># will need to be updated</span>

        <span class="c1"># activated &amp; does not have an assigned index</span>
        <span class="n">fix</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">inds</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">branch_supplimental</span><span class="p">[:][</span><span class="s2">&quot;inds_closest&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fix</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># same process as above, only for fix</span>
        <span class="n">current_means</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">fix</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">current_means</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">inds_closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfriends</span><span class="p">]</span>

        <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">branch_supplimental</span><span class="p">[</span><span class="n">fix</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;inds_closest&quot;</span><span class="p">:</span> <span class="n">inds_closest</span>
        <span class="p">}</span>

        <span class="c1"># verify everything worked</span>
        <span class="n">fix_check</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">inds</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">branch_supplimental</span><span class="p">[:][</span><span class="s2">&quot;inds_closest&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fix_check</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_friends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">branch_supps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># prepare buffer array</span>
        <span class="n">friends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># determine the closest friends for s_inds == True</span>
        <span class="n">inds_closest_here</span> <span class="o">=</span> <span class="n">branch_supps</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">s_inds</span><span class="p">][</span><span class="s2">&quot;inds_closest&quot;</span><span class="p">]</span>

        <span class="c1"># take one at random</span>
        <span class="n">random_inds</span> <span class="o">=</span> <span class="n">inds_closest_here</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">inds_closest_here</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nfriends</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">inds_closest_here</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
            <span class="p">),</span>
        <span class="p">]</span>

        <span class="c1"># store in buffer array</span>
        <span class="n">friends</span><span class="p">[</span><span class="n">s_inds</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">friends</span><span class="p">[</span><span class="n">random_inds</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">friends</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># set random seed</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">nleaves_max</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">nleaves_min</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">branch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span>

<span class="c1"># initialize</span>
<span class="n">nfriends</span> <span class="o">=</span> <span class="n">nwalkers</span>
<span class="n">moves</span> <span class="o">=</span> <span class="n">MeanGaussianGroupMove</span><span class="p">(</span><span class="n">nfriends</span><span class="o">=</span><span class="n">nfriends</span><span class="p">,</span> <span class="n">n_iters_update</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))}</span>

<span class="c1"># this is the sigma for the multivariate Gaussian that sets starting points</span>
<span class="c1"># We need it to be very small to assume we are passed the search phase</span>
<span class="c1"># we will verify this is with likelihood calculations</span>
<span class="n">sig1</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="c1"># describes priors for all leaves independently</span>
<span class="n">priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">ProbDistContainer</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>  <span class="c1"># amplitude</span>
            <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>  <span class="c1"># mean</span>
            <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">),</span>  <span class="c1"># sigma</span>
        <span class="p">}</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="c1"># setup initial walkers as one starting guess</span>
<span class="n">coords</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priors</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>

<span class="n">inds</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)}</span>
<span class="n">inds</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># setup starting state</span>
<span class="kn">from</span> <span class="nn">eryn.state</span> <span class="kn">import</span> <span class="n">BranchSupplimental</span>

<span class="c1">### KEY PART OF SETUP</span>
<span class="c1"># build branch supplimental to properly track information</span>
<span class="c1"># see below description of Branch Supplimental objects.</span>
<span class="n">branch_supps</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">BranchSupplimental</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;inds_closest&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">nfriends</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)},</span>
        <span class="n">base_shape</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">}</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span>
    <span class="n">coords</span><span class="p">,</span>
    <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span>
    <span class="n">branch_supplimental</span><span class="o">=</span><span class="n">branch_supps</span><span class="p">,</span>
<span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndim</span><span class="p">,</span>
    <span class="n">log_like_fn_gauss_pulse</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ntemps</span><span class="o">=</span><span class="n">ntemps</span><span class="p">),</span>
    <span class="n">nbranches</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_names</span><span class="p">),</span>
    <span class="n">branch_names</span><span class="o">=</span><span class="n">branch_names</span><span class="p">,</span>
    <span class="n">nleaves_max</span><span class="o">=</span><span class="n">nleaves_max</span><span class="p">,</span>
    <span class="n">nleaves_min</span><span class="o">=</span><span class="n">nleaves_min</span><span class="p">,</span>
    <span class="n">moves</span><span class="o">=</span><span class="n">moves</span><span class="p">,</span>
    <span class="n">rj_moves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># basic generation of new leaves from the prior</span>
<span class="p">)</span>

<span class="n">log_prior</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_prior</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_like</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span> <span class="n">logp</span><span class="o">=</span><span class="n">log_prior</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">state</span><span class="o">.</span><span class="n">log_prior</span> <span class="o">=</span> <span class="n">log_prior</span>
<span class="n">state</span><span class="o">.</span><span class="n">log_like</span> <span class="o">=</span> <span class="n">log_like</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><br/><span></span><span class="n">nsteps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">last_sample</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span>
    <span class="n">state</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████████████████████████| 100/100 [00:02&lt;00:00, 36.66it/s]
100%|███████████████████████████████████████| 1000/1000 [00:30&lt;00:00, 32.88it/s]
</pre></div></div>
</div>
<p>Plot result. You may need to run this much longer to get a reasonable looking plot.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span>
    <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">][</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_inds</span><span class="p">()[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
    <span class="n">hist_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">smooth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_113_0.png" src="../_images/tutorial_Eryn_tutorial_113_0.png" />
</div>
</div>
</section>
</section>
<section id="Utilities">
<h2>Utilities<a class="headerlink" href="#Utilities" title="Link to this heading"></a></h2>
<p>Eryn provides many different utilities for sampling. We will show a bit of their usages here, but refer to the <a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/utils.html#periodic-container">Utility documentation</a> for more direct information.</p>
<section id="Branch-Supplimental">
<h3>Branch Supplimental<a class="headerlink" href="#Branch-Supplimental" title="Link to this heading"></a></h3>
<p>While the <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> object is considered a utility, it is documented and stored within the section on the <code class="docutils literal notranslate"><span class="pre">State</span></code> objects (see <a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/state.html#state">here</a>).</p>
<p>Sometimes, in sampling, we want to pass information through the sampler that is particular to each walker or leaf in our ensemble. Storing a different covariance matrix for each walker would be an example of this.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> object is designed to do this. In our example above on the <code class="docutils literal notranslate"><span class="pre">GroupStretchMove</span></code>, we used <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> objects to hold and pass friend information through the sampler.</p>
<p>A <strong>major</strong> benefit of the branch supplimental is its indexing capabilities. As sampling proceeds, temperature swaps and accept/reject actions will change the current state coordinates and locations of each walker/leaf. The branch supplimental allows the sampling to track and move all of this extra information properly. For example, during a temperature swap, walker 0 in temperature 0 is swapped with walker 1 in temperature 1. This requires all information associated with (t,w)=(0, 0) to swap
with walker information in (1,1). Eryn already does this directly for coordinates, inds, log like, log prior, etc. The branch supplimental ensures this swapping occurs properly for any <em>other</em> information you want to add that needs to track with each walker/leaf in the sampler.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">eryn.state</span> <span class="kn">import</span> <span class="n">BranchSupplimental</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> objects are initialized with a dictionary with keys as names of the information and values as the array objects. These arrays can be <code class="docutils literal notranslate"><span class="pre">dtype=object</span></code> as well. This is discussed below. The <code class="docutils literal notranslate"><span class="pre">base_shape</span></code> gives the sampler shape of interest. Usually this is <code class="docutils literal notranslate"><span class="pre">(ntemps,</span> <span class="pre">nwalkers,</span> <span class="pre">nleaves_max)</span></code> or <code class="docutils literal notranslate"><span class="pre">(ntemps,</span> <span class="pre">nwalkers)</span></code>. The indexing of the <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> object will occur along this <code class="docutils literal notranslate"><span class="pre">base_shape</span></code>. It will return any dimensions beyond this base shape.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ntemps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">nleaves_max</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">n_info</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">important_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">n_info</span><span class="p">))</span>
<span class="n">branch_supp</span> <span class="o">=</span> <span class="n">BranchSupplimental</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;important_value&quot;</span><span class="p">:</span> <span class="n">important_value</span><span class="p">},</span>
    <span class="n">base_shape</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">),</span>
    <span class="n">copy</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>You can index and set the supplimental values in a simple way.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># index the object. It will return a dictionary.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BEFORE:&quot;</span><span class="p">,</span> <span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="c1"># set the object with a dictionary</span>
<span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;important_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])}</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AFTER:&quot;</span><span class="p">,</span> <span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="c1"># set the object with another value (which is a dictionary)</span>
<span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AFTER2:&quot;</span><span class="p">,</span> <span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BEFORE: {&#39;important_value&#39;: array([ 52, 403, 967, 444, 130])} {&#39;important_value&#39;: array([513, 587, 735, 702, 764])}
AFTER: {&#39;important_value&#39;: array([1, 2, 3, 4, 5])} {&#39;important_value&#39;: array([513, 587, 735, 702, 764])}
AFTER2: {&#39;important_value&#39;: array([513, 587, 735, 702, 764])} {&#39;important_value&#39;: array([513, 587, 735, 702, 764])}
</pre></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> objects are quietly powerful. You do not <em>need</em> to store numpy arrays as the supplimental. It can really be any object. Even, e.g., specialized class objects. In this case, you can store each class instance in a numpy array with <code class="docutils literal notranslate"><span class="pre">dtype=object</span></code> with <code class="docutils literal notranslate"><span class="pre">base_shape=(ntemps,</span> <span class="pre">nwalkers,</span> <span class="pre">nleaves_max)</span></code>. Then, when indexing or adjusting, the branch supplimental will index as usual at the <code class="docutils literal notranslate"><span class="pre">base_shape</span></code> level.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CarryAnything</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicator</span> <span class="o">=</span> <span class="n">indicator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span>

<span class="n">carry_any</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntemps</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">):</span>
            <span class="n">carry_any</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CarryAnything</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>

<span class="n">carry_any</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">carry_any</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">carry_any</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">carry_any</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(10, 30, 12)
[&lt;__main__.CarryAnything object at 0x137cf54f0&gt;
 &lt;__main__.CarryAnything object at 0x1368f4b30&gt;]
</pre></div></div>
</div>
<p>The branch supplimental is now built simply with two key-value pairs in the input dictionary. Even though they have different overall shapes, the two inputs have the same <code class="docutils literal notranslate"><span class="pre">base_shape</span></code> and can be indexed together properly.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">branch_supp_inputs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;important_value&quot;</span><span class="p">:</span> <span class="n">important_value</span><span class="p">,</span>
    <span class="s2">&quot;carry_any&quot;</span><span class="p">:</span> <span class="n">carry_any</span>
<span class="p">}</span>

<span class="n">branch_supp</span> <span class="o">=</span> <span class="n">BranchSupplimental</span><span class="p">(</span>
    <span class="n">branch_supp_inputs</span><span class="p">,</span>
    <span class="n">base_shape</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">),</span>
    <span class="n">copy</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">branch_supp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">branch_supp</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">][</span><span class="s2">&quot;carry_any&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;important_value&#39;: array([ 52, 403, 967, 444, 130]), &#39;carry_any&#39;: &lt;__main__.CarryAnything object at 0x135204dd0&gt;}
10
</pre></div></div>
</div>
<p>For direct access to the holder arrays, you can access the <code class="docutils literal notranslate"><span class="pre">holder</span></code> attribute.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">branch_supp</span><span class="o">.</span><span class="n">holder</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([&#39;important_value&#39;, &#39;carry_any&#39;])
</pre></div></div>
</div>
</section>
<section id="Transform-Container">
<h3>Transform Container<a class="headerlink" href="#Transform-Container" title="Link to this heading"></a></h3>
<p>Transform containers are primary used in likelihood functions to transform the arrays incoming from the sampler to the proper setup for likelihood computation. It can transform parameters based on transform functions and fill values into a final array for any value that is fixed during sampling.</p>
<p>It can be passed to the likeihood function as an <code class="docutils literal notranslate"><span class="pre">arg</span></code> or <code class="docutils literal notranslate"><span class="pre">kwarg</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># can be done with lambda or regular function</span>
<span class="c1"># must have same number of inputs and outputs at same index in outer arrays</span>
<span class="k">def</span> <span class="nf">transform1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">/</span> <span class="n">x</span>

<span class="c1"># this will do transform lambda x, y: (x**2, y**2) before transform1</span>
<span class="n">parameter_transforms</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="n">transform1</span><span class="p">}</span>

<span class="n">fill_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ndim_full&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># full dimensionality after values are added</span>
    <span class="s2">&quot;fill_inds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>  <span class="c1"># indexes for fill values in final array</span>
    <span class="s2">&quot;fill_values&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]),</span>  <span class="c1"># associated values for filling</span>
<span class="p">}</span>

<span class="n">tc</span> <span class="o">=</span> <span class="n">TransformContainer</span><span class="p">(</span><span class="n">parameter_transforms</span><span class="o">=</span><span class="n">parameter_transforms</span><span class="p">,</span> <span class="n">fill_dict</span><span class="o">=</span><span class="n">fill_dict</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># can copy and transpose values if needed</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">transform_base_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[ 2.26227781e+00  7.71172976e+00  1.27548736e+00]
 [ 2.56370157e+00  1.34990453e-01  2.05917997e+00]
 [-1.48759469e+00  9.74032231e+00 -5.81326542e+01]
 [ 6.50447002e-02  1.63975125e+00  1.46380376e+00]
 [ 9.53877519e+00  7.79897194e-02  2.09789713e+01]
 [ 4.06410029e+00  1.26998074e+01  3.49285015e+00]
 [ 1.54376007e+01  1.38051140e+01  8.84060841e+00]
 [ 1.38300414e+01  2.53601577e+00  1.75672789e+01]
 [ 1.73703931e+00  9.27046560e+00  2.46312421e+01]
 [ 4.78771247e-01  3.75305760e+00  1.06581635e+00]
 [ 1.88147701e-02  2.34955242e-02  3.94187130e-02]
 [ 1.71883744e+01  2.54740727e-02  8.97001618e+00]
 [ 5.98474438e+00  3.00342614e+00  5.88277683e+00]
 [ 6.32764883e+00  2.34138626e-01  4.35158910e+00]
 [ 3.83219365e+00  1.24534275e+01  1.02614546e+01]
 [ 1.97048601e-01  1.66615073e+00  4.51228417e+00]
 [ 9.76220395e+00  1.16789539e+01  1.26683150e+01]
 [ 4.82678472e+00  3.07381945e+00  8.61128946e+00]
 [ 1.69598253e+00  1.18751365e+01  2.01722672e+01]
 [ 1.07081046e+00  1.53621702e+01  1.11803061e+00]
 [ 3.16326742e+00  4.02708000e+00  4.10980080e+00]
 [ 4.45485130e+00  3.87056124e+00  3.05496019e+00]
 [-5.96313442e-01  1.35690268e+01 -1.54661617e+00]
 [ 3.11288581e+00  6.68544747e-01  2.69885225e+00]
 [ 4.11935523e+00  6.96904238e+00  7.91590796e+00]
 [ 3.06494985e+00  2.75972186e-01  3.14017465e+01]
 [ 1.87475913e+01  3.91251640e-01  1.16695627e+01]
 [ 2.66873057e-01  7.02594142e+00  1.45960933e-01]
 [ 5.33294936e+00  6.11129950e+00  3.22032393e+00]
 [-1.02392877e+00  3.86543400e-01 -4.37596988e+00]
 [ 3.18067491e+00  8.25836145e-01  1.33798856e+01]
 [ 5.62668854e+00  9.78027707e+00  3.52857318e+00]
 [-5.99820781e-02  4.79023757e+00 -3.70779337e-01]
 [ 3.62128048e+00  8.37144246e+00  1.07501880e+01]
 [ 3.95266270e-01  7.04161418e-01  2.02500595e+00]
 [ 1.34621385e+01  7.98391055e-01  9.13549746e+00]
 [-1.34151067e+01  8.40039254e+00 -3.57508963e+00]
 [ 8.54177631e+00  9.17191891e+00  6.84911323e+00]
 [-2.07751004e+01  6.12957529e+00 -6.70874225e+00]
 [ 8.48004061e+00  1.06033804e+01  5.51752276e+00]]
</pre></div></div>
</div>
<p>If you have mutliple branches in your sampler, you can add more than one <code class="docutils literal notranslate"><span class="pre">Transform</span> <span class="pre">Container</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lnprob</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">group1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">transform_containers</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="n">transform_containers</span><span class="p">)):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">transform_base_parameters</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">fill_values</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1">## do more in the likelihood here with transformed information</span>

<span class="c1"># setup transforms for x1</span>
<span class="n">parameter_transforms1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="c1"># setup transforms for x2</span>
<span class="n">parameter_transforms2</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)}</span>

<span class="c1"># fill dict for x1</span>
<span class="n">fill_dict1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ndim_full&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># full dimensionality after values are added</span>
    <span class="s2">&quot;fill_inds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>  <span class="c1"># indexes for fill values in final array</span>
    <span class="s2">&quot;fill_values&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]),</span>  <span class="c1"># associated values for filling</span>
<span class="p">}</span>

<span class="c1"># fill dict for x2</span>
<span class="n">fill_dict2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ndim_full&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># full dimensionality after values are added</span>
    <span class="s2">&quot;fill_inds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>  <span class="c1"># indexes for fill values in final array</span>
    <span class="s2">&quot;fill_values&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]),</span>  <span class="c1"># associated values for filling</span>
<span class="p">}</span>

<span class="n">tcs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">TransformContainer</span><span class="p">(</span><span class="n">parameter_transforms</span><span class="o">=</span><span class="n">parameter_transforms1</span><span class="p">,</span> <span class="n">fill_dict</span><span class="o">=</span><span class="n">fill_dict1</span><span class="p">),</span>
    <span class="n">TransformContainer</span><span class="p">(</span><span class="n">parameter_transforms</span><span class="o">=</span><span class="n">parameter_transforms2</span><span class="p">,</span> <span class="n">fill_dict</span><span class="o">=</span><span class="n">fill_dict2</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">num</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">group1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">group2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

<span class="c1"># it can be added via args or kwargs in the ensemble sampler</span>
<span class="n">lnprob</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">group1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">tcs</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[array([[ 1.36408262,  0.15052344,  0.        ,  1.        ,  3.48800761,
        -1.        ],
       [ 1.29897891,  3.01041913,  0.        ,  1.        ,  2.97851441,
        -1.        ],
       [ 1.3653482 ,  1.21394415,  0.        ,  1.        ,  3.25311149,
        -1.        ],
       [ 1.16750397,  2.64909661,  0.        ,  1.        ,  1.45690912,
        -1.        ],
       [ 1.1861526 ,  0.93322534,  0.        ,  1.        ,  3.58088928,
        -1.        ],
       [ 0.08555872,  0.13786158,  0.        ,  1.        ,  3.43834971,
        -1.        ],
       [-0.02352741,  1.71808764,  0.        ,  1.        ,  3.63735008,
        -1.        ],
       [ 1.07232766,  1.39277427,  0.        ,  1.        ,  0.63799694,
        -1.        ],
       [ 1.21732595,  3.14024127,  0.        ,  1.        ,  0.69714093,
        -1.        ],
       [ 0.26845662,  2.84958172,  0.        ,  1.        ,  1.44775212,
        -1.        ],
       [ 0.55606073,  3.12060581,  0.        ,  1.        ,  3.68667253,
        -1.        ],
       [ 0.97680555,  3.65644994,  0.        ,  1.        ,  3.39990504,
        -1.        ],
       [ 0.63347517,  2.07772332,  0.        ,  1.        ,  3.32185317,
        -1.        ],
       [ 0.54807996,  1.63004179,  0.        ,  1.        ,  3.63537474,
        -1.        ],
       [ 0.78315515,  1.74865946,  0.        ,  1.        ,  2.72034487,
        -1.        ],
       [ 0.62543905,  3.89346839,  0.        ,  1.        ,  3.81664149,
        -1.        ],
       [ 0.25188632,  2.9573227 ,  0.        ,  1.        ,  1.29585671,
        -1.        ],
       [-0.07794654,  0.24376449,  0.        ,  1.        ,  2.28643517,
        -1.        ],
       [ 1.05373448,  1.80619337,  0.        ,  1.        ,  0.49407366,
        -1.        ],
       [ 0.61174823,  0.25112653,  0.        ,  1.        ,  1.49639733,
        -1.        ],
       [ 1.14970147,  2.03962511,  0.        ,  1.        ,  1.01071637,
        -1.        ],
       [ 1.17866892,  3.44375584,  0.        ,  1.        ,  2.89257887,
        -1.        ],
       [ 1.25003678,  3.97263296,  0.        ,  1.        ,  2.28063182,
        -1.        ],
       [ 1.28028481,  2.67240503,  0.        ,  1.        ,  1.88979263,
        -1.        ],
       [ 0.93052516,  0.98698515,  0.        ,  1.        ,  1.49915708,
        -1.        ],
       [ 1.28665103,  0.94348679,  0.        ,  1.        ,  2.8971265 ,
        -1.        ],
       [ 0.80048835,  0.22247766,  0.        ,  1.        ,  2.58255823,
        -1.        ],
       [ 0.68911496,  3.48062074,  0.        ,  1.        ,  1.04180256,
        -1.        ],
       [ 1.04477123,  2.76761527,  0.        ,  1.        ,  1.8895895 ,
        -1.        ],
       [ 1.11761682,  3.51274366,  0.        ,  1.        ,  1.03211138,
        -1.        ],
       [ 1.35853643,  0.74031876,  0.        ,  1.        ,  3.07061094,
        -1.        ],
       [ 1.25215733,  3.22604585,  0.        ,  1.        ,  2.32227826,
        -1.        ],
       [-1.65465746,  2.10116328,  0.        ,  1.        ,  3.74740296,
        -1.        ],
       [ 1.13880739,  2.16460269,  0.        ,  1.        ,  1.08915955,
        -1.        ],
       [ 1.28951076,  1.33559827,  0.        ,  1.        ,  1.35421215,
        -1.        ],
       [-0.42504646,  3.91291818,  0.        ,  1.        ,  1.41934187,
        -1.        ],
       [-0.98377096,  0.81228842,  0.        ,  1.        ,  2.83893009,
        -1.        ],
       [ 0.94390451,  0.31438458,  0.        ,  1.        ,  3.08240101,
        -1.        ],
       [ 1.07355977,  3.06460086,  0.        ,  1.        ,  1.02755997,
        -1.        ],
       [ 0.73020403,  2.47933908,  0.        ,  1.        ,  0.73662634,
        -1.        ]]), array([[ 1.12687226, -1.        ,  4.00248679,  2.53636448,  3.8903226 ],
       [ 3.85913129, -1.        ,  0.34563185,  1.14920481,  3.36494113],
       [ 0.96183002, -1.        ,  8.16346346,  7.04960439,  3.69095477],
       [ 1.70945362, -1.        ,  0.35545822,  0.03237407,  1.46548275],
       [ 2.26824275, -1.        ,  8.97436765,  4.87113036,  2.22131114],
       [ 1.35178665, -1.        ,  7.83610769,  5.20127569,  0.10671333],
       [ 2.87588294, -1.        , 14.34902369,  0.24361026,  3.46439266],
       [ 0.93154318, -1.        ,  4.12893585,  4.46943857,  0.60840224],
       [ 1.24729566, -1.        ,  0.1734498 ,  4.79654616,  3.91285921],
       [ 2.51556969, -1.        , 14.3047392 ,  0.6397266 ,  2.44207147],
       [ 3.20962925, -1.        ,  2.60030366,  0.19040972,  3.1133263 ],
       [ 2.08560979, -1.        ,  0.62009154,  0.05022364,  2.40225947],
       [ 0.33199571, -1.        ,  0.03074056,  5.71869472,  2.15882122],
       [ 1.47946504, -1.        ,  1.87289675,  0.90151358,  0.24074501],
       [ 2.9770715 , -1.        ,  4.79907015, 12.43276481,  1.65995714],
       [ 3.74138046, -1.        ,  4.22514186,  2.34456864,  2.56201691],
       [ 1.78500232, -1.        ,  1.31720371,  6.57318376,  2.34359725],
       [ 2.00965002, -1.        ,  0.14123776, 11.47295327,  2.03166857],
       [ 3.33775044, -1.        ,  0.16989541,  4.13695376,  2.89669478],
       [ 1.09487498, -1.        , 13.55598354,  2.22904415,  1.51427016],
       [ 0.70048696, -1.        ,  1.23266067, 11.64083866,  2.08934512],
       [ 1.35181021, -1.        ,  9.42599021,  7.28069835,  1.97750598],
       [ 0.3435387 , -1.        , 15.7217224 ,  0.68781272,  1.99812126],
       [ 2.98962262, -1.        ,  4.42467445,  9.79329395,  2.63975936],
       [ 2.49725691, -1.        , 11.14015574, 11.38180071,  0.4340989 ],
       [ 0.9915848 , -1.        ,  9.50677174, 15.1801135 ,  2.0664768 ],
       [ 3.05431651, -1.        ,  3.60922715, 12.52595309,  2.06785213],
       [ 1.0526226 , -1.        ,  9.74426111,  2.43847953,  0.37556454],
       [ 0.55103816, -1.        , 11.7703627 , 11.19127215,  1.61686159],
       [ 3.83934958, -1.        ,  3.69902273, 11.75327062,  3.54293484],
       [ 2.31728036, -1.        ,  0.27001597,  2.77863309,  2.83587134],
       [ 0.23100948, -1.        ,  2.44550709,  3.61791316,  2.31107967],
       [ 3.38838798, -1.        ,  1.60084254,  0.62853765,  3.54487269],
       [ 2.74178253, -1.        ,  1.76503062,  0.75122448,  3.05916718],
       [ 2.90819838, -1.        , 12.59782578,  9.7869203 ,  3.82881016],
       [ 3.52381286, -1.        ,  1.63105348, 10.28011431,  2.25903713],
       [ 3.89240716, -1.        ,  2.75460847,  2.91276999,  0.68357577],
       [ 3.49780335, -1.        ,  1.47979089, 15.00484949,  2.3351851 ],
       [ 2.18227792, -1.        ,  7.10108032,  0.59811628,  0.10842801],
       [ 1.46135392, -1.        ,  6.58120056,  0.42250042,  2.99398862]])]
</pre></div></div>
</div>
</section>
<section id="Multivariate-Prior-Distributions">
<h3>Multivariate Prior Distributions<a class="headerlink" href="#Multivariate-Prior-Distributions" title="Link to this heading"></a></h3>
<p>Eryn also allows for multivariate prior distributions. To pass these, rather than a single index as the dictionary key like before (e.g.<code class="docutils literal notranslate"><span class="pre">1:</span> <span class="pre">dist()</span></code>), it is not a tuple of inds: <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">1):</span> <span class="pre">dist()</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">multivariate_normal</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]])</span>

<span class="n">priors_in</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="n">multivariate_normal</span><span class="p">(</span><span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">priors</span> <span class="o">=</span> <span class="n">ProbDistContainer</span><span class="p">(</span><span class="n">priors_in</span><span class="p">)</span>
<span class="n">prior_vals</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prior_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(12, 2)
</pre></div></div>
</div>
</section>
<section id="Periodic-Container">
<h3>Periodic Container<a class="headerlink" href="#Periodic-Container" title="Link to this heading"></a></h3>
<p>The periodic container accounts for periodic parameters by accounting for periodic boundary conditions in terms of distance and parameter wrapping. The input to periodic containers are dictionaries with the parameter index as the key and the period associated with it as the item. Any parameters that are not periodic do not need to be included.</p>
<p>For example, with a sine model that includes an amplitude (index 0), frequency (index 1), and phase offset (index 2), the phase offset will be periodic.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">eryn.utils</span> <span class="kn">import</span> <span class="n">PeriodicContainer</span>


<span class="n">periodic</span> <span class="o">=</span> <span class="n">PeriodicContainer</span><span class="p">({</span><span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}})</span>
<span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">params_before_1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span> <span class="o">*</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))}</span>
<span class="n">params_before_2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span> <span class="o">*</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))}</span>

<span class="n">distance</span> <span class="o">=</span> <span class="n">periodic</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">params_before_1</span><span class="p">,</span> <span class="n">params_before_2</span><span class="p">)</span>

<span class="c1"># the max distance should be near half the period</span>
<span class="nb">print</span><span class="p">(</span><span class="n">distance</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="n">params_after_1</span> <span class="o">=</span> <span class="n">periodic</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">params_before_1</span><span class="p">)</span>

<span class="c1"># max after wrapping should be near the period</span>
<span class="nb">print</span><span class="p">(</span><span class="n">params_after_1</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3.1396228175679486
6.281999449819018
</pre></div></div>
</div>
</section>
<section id="Stopping-&amp;-Update-Functions">
<h3>Stopping &amp; Update Functions<a class="headerlink" href="#Stopping-&-Update-Functions" title="Link to this heading"></a></h3>
<p>Stopping and Update functions are built, declared, and adjusted in the same way. They both have required Parent base classes. The key similarity between them is the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> function has the same signature: <code class="docutils literal notranslate"><span class="pre">(iteration,</span> <span class="pre">last_sample,</span> <span class="pre">sampler)</span></code>, which gives the class access to the all parts of the sampler object.</p>
<p>Update functions allow the user to adjust anything within the sampler at periodic intervals set by the <code class="docutils literal notranslate"><span class="pre">update_iterations</span></code> kwarg to <code class="docutils literal notranslate"><span class="pre">EnsembleSampler</span></code>. This can also be used to access very types of information. It allows for a ton of customization from the user from within the sampler object. See the <a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/utils.html#update-functions">update documentation</a> for more information.</p>
<p>Stopping functions are effectively convergence functions, allowing the sampler to stop running when it reaches a user-defined criterion. For more information, see the <a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/utils.html#stopping-functions">stopping documentation</a>.</p>
<p>Here, we will just look at a quick example of using the implemented stopping function for Likelihood convergence.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">eryn.utils</span> <span class="kn">import</span> <span class="n">SearchConvergeStopping</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gaussian likelihood</span>
<span class="k">def</span> <span class="nf">log_like_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">invcov</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mu</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invcov</span><span class="p">,</span> <span class="n">diff</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">ndim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># mean</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>  <span class="c1"># np.random.rand(ndim)</span>

<span class="c1"># define covariance matrix</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>
<span class="n">invcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

<span class="c1"># set prior limits</span>
<span class="n">lims</span> <span class="o">=</span> <span class="mf">50.0</span>
<span class="n">priors_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="o">-</span><span class="n">lims</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lims</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)}</span>
<span class="n">priors</span> <span class="o">=</span> <span class="n">ProbDistContainer</span><span class="p">(</span><span class="n">priors_in</span><span class="p">)</span>

<span class="n">stop</span> <span class="o">=</span> <span class="n">SearchConvergeStopping</span><span class="p">(</span><span class="n">n_iters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndim</span><span class="p">,</span>
    <span class="n">log_like_fn</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">means</span><span class="p">,</span> <span class="n">invcov</span><span class="p">],</span>
    <span class="n">stopping_fn</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
    <span class="n">stopping_iterations</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>

<span class="c1"># starting positions</span>
<span class="c1"># randomize throughout prior</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,))</span>

<span class="c1"># check log_like</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
    <span class="n">log_like_fn</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">means</span><span class="p">,</span> <span class="n">invcov</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>

<span class="c1"># check log_prior</span>
<span class="n">log_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
    <span class="n">priors</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_prior</span><span class="p">)</span>


<span class="n">nsteps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="c1"># burn for 1000 steps</span>
<span class="n">burn</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># thin by 5</span>
<span class="n">thin_by</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="n">thin_by</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[-1640.49679761 -2135.49803152 -1902.77160243 -2518.77462291
 -2051.94825594 -2318.71684266 -1845.07485743 -1575.80578615
  -913.80921413 -1108.9449725  -1780.20151453  -979.04011531
 -1885.25829617  -772.78021174 -4961.74355071  -651.92498531
 -4058.42587146 -2222.75261641 -2587.35271764 -2888.26717103
 -2385.10797455 -1067.19887104 -4170.31900754 -3081.79590684
 -1711.62977293 -1921.02255461 -1647.87020108 -1350.79724116
 -1635.07917685 -2978.59460227 -3025.81761755 -2465.65385449
 -1584.44439791  -705.24033014 -2265.53587807 -1800.29764511
 -2211.43468005 -2932.15312204 -2036.16814252 -3251.00408331
 -2218.88843675 -1989.9393407  -1387.18420155 -1249.69733655
 -3231.91216326 -2128.41154584 -1266.54584638 -1738.55937653
 -1474.89128224 -1208.04481689 -2817.42974363 -2230.42847214
 -1881.77767607 -3321.4775246  -1310.57188017 -1404.39592594
 -2688.28462417 -1035.47864803 -1691.88082256 -2441.60925324
 -2263.23620765 -1706.78581038 -1752.00845384 -2282.29407206
 -1137.81695955 -3564.67451667 -2363.60233296 -2000.43831628
 -2028.68778873 -1129.81047553 -2766.82574299  -417.17183832
 -1917.548434   -1166.39969534 -2138.33358483 -1225.25105585
 -1110.89568937  -940.52124789 -1155.42212252 -1835.39263386
 -3442.64290351 -2734.30955334 -1944.82023546 -2678.47097937
 -1191.16174763 -2395.23521606 -2151.11201375 -2164.7197384
 -3467.95403029 -1675.31598053 -3367.0266415  -1295.71312178
 -2383.21420848 -3324.94357378 -2177.44460386 -1041.76021323
  -886.82478613 -1698.56702022 -2270.08719732 -2844.77627149]
[-23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093
 -23.02585093 -23.02585093 -23.02585093 -23.02585093 -23.02585093]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████████████████████████████| 100/100 [00:00&lt;00:00, 291.24it/s]
  3%|█                                       | 63/2500 [00:00&lt;00:07, 314.42it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

ITERS CONSECUTIVE: 0 Previous best LL: -0.09111836076165353 Current best LL: -0.09111836076165353


ITERS CONSECUTIVE: 1 Previous best LL: -0.09111836076165353 Current best LL: -0.09111836076165353


ITERS CONSECUTIVE: 2 Previous best LL: -0.09111836076165353 Current best LL: -0.09111836076165353

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
  6%|██▍                                    | 157/2500 [00:00&lt;00:07, 296.77it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

ITERS CONSECUTIVE: 0 Previous best LL: -0.0742244529294836 Current best LL: -0.0742244529294836


ITERS CONSECUTIVE: 1 Previous best LL: -0.0742244529294836 Current best LL: -0.0742244529294836


ITERS CONSECUTIVE: 2 Previous best LL: -0.0742244529294836 Current best LL: -0.0742244529294836

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
  9%|███▍                                   | 217/2500 [00:00&lt;00:07, 286.14it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

ITERS CONSECUTIVE: 3 Previous best LL: -0.0742244529294836 Current best LL: -0.07399422624832219


ITERS CONSECUTIVE: 0 Previous best LL: -0.04450561782490035 Current best LL: -0.04450561782490035


ITERS CONSECUTIVE: 1 Previous best LL: -0.04450561782490035 Current best LL: -0.04450561782490035

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 12%|████▊                                  | 305/2500 [00:01&lt;00:07, 286.26it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

ITERS CONSECUTIVE: 2 Previous best LL: -0.04450561782490035 Current best LL: -0.04450561782490035


ITERS CONSECUTIVE: 3 Previous best LL: -0.04450561782490035 Current best LL: -0.04450561782490035


ITERS CONSECUTIVE: 4 Previous best LL: -0.04450561782490035 Current best LL: -0.04450561782490035

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 13%|█████                                  | 325/2500 [00:01&lt;00:07, 287.83it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

ITERS CONSECUTIVE: 5 Previous best LL: -0.04450561782490035 Current best LL: -0.04450561782490035

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../user/utils.html" class="btn btn-neutral float-left" title="Utilities" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="more_tutorials.html" class="btn btn-neutral float-right" title="More Advanced Eryn Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Michael Katz and Nikos Karnesis.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>